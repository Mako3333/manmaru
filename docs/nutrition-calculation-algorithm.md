# 栄養計算アルゴリズム詳細ドキュメント

## 1. システム概要

### 1.1 新旧システムの比較

#### 旧システムの課題
- 各入力経路（テキスト・画像・レシピ）で個別の栄養計算ロジックが存在
- データベースアクセスの冗長性
- エラーハンドリングの統一性が欠如

#### 新システムの改善点
- 栄養計算ロジックの統一
- 共通の入力検証レイヤー
- 統一されたエラーハンドリング
- 標準化された栄養データ形式

## 2. 主要コンポーネント

### 2.1 NutritionService
栄養計算の中核を担うサービス。以下の主要機能を提供：

- 個別食品の栄養計算
- 食事全体の栄養計算
- 栄養バランス評価
- 栄養素不足の検出

### 2.2 QuantityParser
食品量の解析と変換を担当：

- テキストからの量情報の抽出
- 標準的なグラム単位への変換
- 信頼度スコアの計算

### 2.3 FoodMatchingService
食品名のマッチングを担当：

- あいまい検索による食品の特定
- マッチング確信度の計算
- 類似食品の提案

## 3. 栄養計算アルゴリズム

### 3.1 基本フロー
1. 入力検証
2. 食品マッチング
3. 量の解析
4. 栄養素の計算
5. 結果の標準化

### 3.2 具体的な計算ロジック

```typescript
// 1. 単一食品の栄養計算
calculateSingleFoodNutrition(food, quantity):
  1. 入力された量をグラムに変換
  2. 100gあたりの栄養価から実際の量に応じた栄養価を計算
  3. 食品データと量の信頼度から総合的な信頼度を計算
  4. 標準化された形式で結果を返却

// 2. 複数食品の栄養合計
calculateNutrition(foodItems):
  1. 各食品について個別に栄養計算
  2. MVPの6栄養素（カロリー、タンパク質、鉄分、カルシウム、葉酸、ビタミンD）を合算
  3. 食品ごとの信頼度から平均信頼度を計算
  4. 食品リストと合計栄養価を含む結果を返却
```

### 3.3 栄養バランス評価

```typescript
evaluateNutritionBalance(nutrition, targetValues):
  1. MVPの6栄養素それぞれについて
  2. 目標値に対する充足率を計算（最大100%）
  3. 全栄養素の平均充足率を算出
  4. 0-100のスコアに変換して返却
```

### 3.4 栄養素不足の検出

```typescript
identifyDeficientNutrients(nutrition, targetValues, threshold = 0.7):
  1. MVPの6栄養素それぞれについて
  2. 目標値に対する充足率を計算
  3. 閾値（デフォルト70%）未満の栄養素を特定
  4. 不足している栄養素の詳細情報を返却
```

## 4. エラーハンドリング

### 4.1 主要なエラーケース
- 食品が見つからない場合
- 量の変換に失敗した場合
- 低信頼度マッチングの場合

### 4.2 エラー処理方針
- バリデーションエラー → 統一エラーハンドラで処理
- 食品未検出 → 代替候補の提案
- 低信頼度 → 警告情報付きで処理継続

## 5. 信頼度スコアの計算

### 5.1 個別の信頼度
- 食品データの信頼度（デフォルト0.8）
- 量の解析信頼度
- マッチング信頼度

### 5.2 総合信頼度の計算
- 各要素の信頼度の最小値を採用
- 複数食品の場合は平均値を使用

## 6. テスト項目

### 6.1 基本機能テスト
- 単一食品の栄養計算
- 複数食品の栄養合計
- 標準化されたデータ形式への変換

### 6.2 栄養評価テスト
- 目標値達成度の評価
- 栄養バランススコアの計算
- 不足栄養素の特定

### 6.3 エラーケーステスト
- 食品未検出時の処理
- 部分的なエラー発生時の継続処理
- バリデーションエラーのハンドリング
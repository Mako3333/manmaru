

# 栄養アドバイス機能インシデント報告書

## 1. インシデント概要
- **報告日**: 2025年3月7日
- **影響範囲**: 妊婦向け栄養管理アプリ「manmaru」の栄養アドバイス生成機能
- **問題の重大度**: 中程度（機能は稼働するが、不正確なアドバイスが生成される可能性）
- **発見方法**: ログ分析とテストデータによる検証

## 2. 検出された問題

### 2.1 主要な問題点

#### テンプレートエンジンの条件分岐処理の不具合
- 条件によって表示を切り替えるべき文章が同時に表示される矛盾
  - 例: 「特に不足している栄養素: タンパク質...」と「現在の栄養状態は良好です」が同時表示

#### 栄養データの不一致
- データベースには実際の値が存在するが、アドバイス生成で使われるデータが全て0%と表示
  - 実例: タンパク質実際の値は80.82%だが、表示データでは0%

#### 不足栄養素の判定ロジックの問題
- 当日のデータのみを使用するため、朝の時点では全ての栄養素が不足と判定
- タンパク質が80%以上摂取されているにもかかわらず、不足と誤判定

#### TypeScript型エラー
- dayパラメーターの型が明示されていない
- オブジェクトのインデックスアクセス方法に問題
- 変数の再宣言エラー

### 2.2 根本原因

#### テンプレート処理の欠陥
- ネストされた条件・ループブロックの処理順序が不適切
- 変数置換が複雑なコンテキストで機能しない
- データ取得関数のマッピング誤り

```typescript
// 誤ったコード
return data.map(record => ({
    nutrients: {
        calories: { percentage: record.calories_goal ? Math.round((record.calories_consumed / record.calories_goal) * 100) : 0 },
        // 他も同様...
    }
}));
```
- 存在しないcalories_consumedとcalories_goalを参照している

#### 栄養判定の時間的視点の欠如
- 一日単位ではなく、週間単位で見るべき栄養素判定を当日データのみで判断

## 3. 問題修正プロセス

### 3.1 テンプレートエンジンの改善

条件分岐処理の書き換え:
```typescript
private static processConditionalBlocks(template: string, context: Record<string, any>): string {
    // 条件分岐を正しく処理するロジック
    const ifRegex = /\{\{\s*#if\s+([^}]+)\s*\}\}([\s\S]*?)(?:\{\{\s*else\s*\}\}([\s\S]*?))?\{\{\s*\/if\s*\}\}/g;
    // 最後のマッチから処理（ネスト対応）
    // ...
}
```

### 3.2 データ処理の修正

正確なデータマッピング:
```typescript
return data.map(record => ({
    date: record.meal_date,
    overallScore: calculateOverallScore(record),
    nutrients: {
        calories: { percentage: record.calories_percent || 0 },
        protein: { percentage: record.protein_percent || 0 },
        // ...
    }
}));
```

過去数日間の平均値による不足栄養素判定:
```typescript
if (pastNutritionData.length > 0) {
    // 栄養素ごとの平均値を計算
    const avgNutrients = { /* ... */ };
    
    pastNutritionData.forEach(day => {
        avgNutrients.protein += day.nutrients.protein.percentage;
        // ...
    });
    
    // 平均値を算出
    // 70%未満を不足と判定
}
```

### 3.3 型安全性の向上
```typescript
interface NutrientAverages {
    protein: number;
    iron: number;
    folic_acid: number;
    calcium: number;
    vitamin_d: number;
    [key: string]: number; // インデックスシグネチャ追加
}

interface NutritionDay {
    date: string;
    overallScore: number;
    nutrients: {
        protein: { percentage: number };
        // ...
    };
}
```

## 4. 改善結果と検証

### 4.1 修正後のログ出力
```
栄養アドバイスAPI: 過去数日間の平均から算出した不足栄養素 [ '鉄分', '葉酸', 'カルシウム', 'ビタミンD' ]
栄養アドバイスAPI: 生成されたプロンプト:
過去数日間のデータから、特に不足している栄養素: 鉄分,葉酸,カルシウム,ビタミンD

直近の栄養摂取状況:
- 2025-03-06: 総合スコア 40点
  カロリー: 62.73%, タンパク質: 80.82%,
  鉄分: 28.14%, 葉酸: 24.66%,
  カルシウム: 22.3%, ビタミンD: 20%
```

### 4.2 改善された点

#### 正確なデータ表示
- 実際の栄養パーセント値が表示されるようになった
- 過去数日の平均値から不足栄養素を判定

#### 条件分岐の正確な処理
- 矛盾した情報が表示されなくなった
- カンマ区切りで栄養素が表示

#### 型安全なコード
- 明示的な型定義によりエラーを防止
- データアクセスの堅牢性向上

## 5. 残存課題と今後の対応

### Next.jsの非同期API警告
- Error: Route "/api/nutrition-advice" used `cookies().get(...)`
- 対応: 非同期APIの適切な使用方法への移行

### 文字列処理の微調整
- 栄養素名に余分な空白が含まれる問題
- 対応: `trim()` メソッドによる空白除去

### 評価期間の最適化
- 現在3日間の栄養データを使用
- 検討: ユーザーの栄養パターンに基づく最適な評価期間の調査

## 6. 結論
テンプレートエンジンのロジック改善、データ処理の修正、型安全性の向上により、栄養アドバイス機能は大幅に改善されました。過去数日間の栄養データを平均して判定することで、より正確で個別化されたアドバイスが生成できるようになりました。

残存する小さな問題については優先度に応じて対応し、ユーザー体験のさらなる向上を目指します。

# レシピプレースホルダー画像表示インシデント報告書

## 1. インシデント概要
- **報告日**: 2025年3月19日
- **影響範囲**: 妊婦向け栄養管理アプリ「manmaru」のレシピ画像表示機能
- **問題の重大度**: 中（機能は動作するが、ユーザー体験に影響する視覚的不整合）
- **発見方法**: InstagramとTikTokからのレシピクリップ時のプレースホルダー画像表示の不整合

## 2. 検出された問題

### 2.1 主要な問題点

#### プレースホルダー画像表示の不整合
- レシピ詳細画面ではプレースホルダー画像が正常に表示される
- マイレシピ画面では同じレシピが「No Image」と表示される
- ソーシャルメディアからのクリップでスクリーンショットがない場合に発生

```
【再現手順】
1. InstagramまたはTikTokからレシピをクリップ
2. スクリーンショットを追加せずにプレースホルダーを使用
3. マイレシピ画面に戻る
4. プレースホルダーの代わりに「No Image」が表示される
```

### 2.2 根本原因

#### コンポーネント間のデータ伝達の不完全性
- マイレシピ画面(`recipes-client.tsx`)からレシピカードコンポーネント(`recipe-card.tsx`)に渡すデータに重要なプロパティが欠落
- 欠落していたプロパティ：
  - `source_platform`: ソーシャルメディアプラットフォーム情報
  - `content_id`: コンテンツID
  - `use_placeholder`: プレースホルダー画像使用フラグ
- レシピカード内での条件分岐（`isSocialMedia`）が正しく判定できない状態

#### プログラム論理の不一致
- レシピ詳細画面では完全なデータ構造が使用されていた
- マイレシピ画面では必要なプロパティが一部省略されていた

## 3. 問題修正プロセス

### 3.1 コード分析
- レシピ詳細画面とマイレシピ画面の画像表示ロジックを比較
- レシピカードに渡されるデータ構造の確認

### 3.2 修正内容
- マイレシピ画面からレシピカードに渡すデータオブジェクトに不足していたプロパティを追加

```typescript
// 修正前 (src/app/(authenticated)/recipes/recipes-client.tsx)
recipe={{
    id: recipe.id,
    title: recipe.title,
    image_url: recipe.image_url,
    recipe_type: recipe.recipe_type,
    nutrition_focus: recipe.nutrition_focus,
    is_favorite: recipe.is_favorite,
    caution_level: recipe.caution_level
}}

// 修正後
recipe={{
    id: recipe.id,
    title: recipe.title,
    image_url: recipe.image_url,
    recipe_type: recipe.recipe_type,
    nutrition_focus: recipe.nutrition_focus,
    is_favorite: recipe.is_favorite,
    caution_level: recipe.caution_level,
    source_platform: recipe.source_platform,
    content_id: recipe.content_id,
    use_placeholder: recipe.use_placeholder
}}
```

## 4. 改善結果と検証

### 4.1 表示一貫性の確保
- マイレシピ画面でもレシピ詳細画面と同様にプレースホルダー画像が正しく表示されるように
- `source_platform`に基づいたブランド特有の背景色やアイコンも正しく表示

### 4.2 プロパティ伝達の完全性確保
- データベース上の情報がUI層まで適切に伝達されるようになった
- `use_placeholder`フラグがTRUEの場合、両画面で同一のプレースホルダー表示

## 5. 今後の対策

### 5.1 型定義の強化
- コンポーネント間のデータ受け渡しに使用する型の厳格化
- `RecipeCard`コンポーネントの`recipe`プロパティの型チェック強化

### 5.2 テスト拡充
- ソーシャルメディアレシピのプレースホルダー表示に関する専用のE2Eテスト追加
- 様々な状態のレシピカード表示テストの追加

### 5.3 コードレビュープロセスの改善
- コンポーネント間のデータバインディングの完全性チェックをレビュー項目に追加
- UIコンポーネントに必要なプロパティが正しく渡されているかの確認強化

## 6. 結論

今回のインシデントは、コンポーネント間のデータ伝達における不完全性が原因でした。マイレシピ画面からレシピカードコンポーネントにデータを渡す際に、ソーシャルメディアとプレースホルダーに関連するプロパティが含まれていなかったため、画像表示の不整合が発生しました。

この問題は、必要なプロパティを追加することで解決されました。今後は、コンポーネント間のデータ伝達に使用する型を厳格化し、必要なプロパティが適切に渡されているかを確認するテストとコードレビュープロセスを強化していきます。


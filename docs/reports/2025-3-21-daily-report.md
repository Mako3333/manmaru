
◤◢◤◢◤◢◤◢◤◢◤◢◤◢
# 栄養データSupabase移行および栄養素計算精度向上報告書

**日付**: 2024年3月21日

## 概要

本日、栄養データのSupabaseへの移行を完了し、栄養素計算の精度向上を実現するための一連の変更を実施しました。これにより、より正確で効率的な栄養データの管理と計算が可能になります。

## 実施内容

### 1. データベースの再構築
- **新規テーブルの作成**:
  - `food_items`: 食品の詳細情報（カロリー、タンパク質、鉄分、葉酸、カルシウム、ビタミンDなど）を保存
  - `food_aliases`: 食品の代替名（別名）を管理
  - `food_categories`: 食品のカテゴリ分類を管理

- **検索最適化**:
  - 食品名とエイリアスにGINインデックスを適用し、検索効率を向上

### 2. Supabase統合の実装
- **SupabaseFoodDatabaseクラスの開発**:
  - シングルトンパターンを採用したデータベースアクセス
  - 30分間有効のキャッシュメカニズム導入によるパフォーマンス向上
  - 食品データの正規化と効率的な検索処理の実装

- **ファジー検索機能の強化**:
  - 完全一致、部分一致、あいまい検索をサポートするSQL関数を実装
  - エイリアスを考慮した高度な検索アルゴリズムの導入

### 3. データ移行プロセス
- **移行スクリプトの開発**:
  - `migrate-food-data.ts`を作成し、JSONデータをSupabaseに移行
  - バッチ処理による効率的なデータ投入（50件単位）
  - データの検証と整合性確保のためのエラーハンドリング実装

### 4. 栄養計算ロジックの改良
- **栄養素計算の精度向上**:
  - Supabaseを優先利用し、障害時にはローカルDBにフォールバックする仕組み
  - 量の表現をより具体的に（「少し」を10-20gに明確化）
  - 異常値チェック機能の追加による計算結果の信頼性向上

- **食品名マッチング精度の改善**:
  - 標準的な日本語への変換時に元の食品名を優先（例：「竹輪」と「ちくわ」を区別）
  - エイリアスと類似検索を組み合わせた高精度なマッチングアルゴリズム実装

### 5. 依存関係の最適化
- **パッケージの更新**:
  - `@supabase/supabase-js`を2.49.1に更新
  - `ts-node`の追加による開発効率向上
  - 不要なBabelプラグインの削除によるプロジェクト軽量化

## 効果と今後の展望

今回の変更により以下の効果が期待されます：

1. **データ品質の向上**: 構造化されたデータモデルにより、栄養情報の一貫性と正確性が向上
2. **検索精度の向上**: ファジー検索とエイリアス対応により、ユーザーの入力に対する柔軟な対応が可能に
3. **計算精度の向上**: より正確な量の解釈と栄養素計算により、ユーザーに信頼性の高い情報を提供
4. **システム安定性の向上**: フォールバック機能とエラーハンドリングの強化によりシステムの耐障害性向上

今後は、ユーザーフィードバックを収集し、検索機能のさらなる最適化や、新たな栄養素データの追加を検討していきます。また、パフォーマンスモニタリングを継続し、必要に応じてキャッシュ戦略の調整を行う予定です。



◤◢◤◢◤◢◤◢◤◢◤◢◤◢
## 対応したインシデント報告：食品エイリアス検索問題

### 問題概要
食品エイリアスの検索機能に関して、以下の問題が発見されました：

1. **誤マッチングの発生**: 「竹輪」を検索した際に「ちくわぶ」などの類似度の低い（0.25程度）別食品とマッチしてしまう問題が発生
2. **栄養計算の誤差**: 誤マッチングにより栄養計算に大きな誤差が生じる（例：カロリー値が期待値の1.3倍など）
3. **エイリアステーブルの活用不足**: 登録済みのエイリアスが効果的に使用されず、検索優先順位が適切でなかった

### 実施した対策

1. **検索優先順位の最適化**:
   - 完全エイリアス一致を最優先する検索ロジックに変更
   - 検索プロセスを「1_alias_exact」→「2_direct_exact」→「3_alias_partial」→「4_alias_fuzzy」→「5_direct_fuzzy」の順に明示的に設定

2. **SQL関数の改良**:
   ```sql
   CREATE OR REPLACE FUNCTION fuzzy_search_food_with_aliases(...)
   -- エイリアス完全一致を最優先する検索ロジックに変更
   -- match_typeに数字プレフィックスを追加して確実に順序通りに並べるよう改善
   ```

3. **類似度計算の精緻化**:
   - エイリアス完全一致に最高スコア(1.0)を付与
   - 食品名完全一致は次点(0.99)とするスコア調整
   - 低類似度の食品との誤マッチを防ぐため閾値を調整

### 検証結果

1. **「竹輪」のテスト**:
   - 修正前: 「ちくわぶ」と誤マッチ → 栄養計算に大きな誤差
   - 修正後: 正しく「ちくわ」とマッチ → 理論値通りの栄養計算を実現

2. **「玉ねぎ」と「ごま」の組み合わせテスト**:
   - 修正後の栄養計算結果が理論値とほぼ一致（誤差5%以内）
   - 信頼度スコアも0.63-0.66と適切なレベルに

### 今後の展望

1. **エイリアス管理の拡充**:
   - 調理法による栄養価の違いに対応するため、「玉ねぎ」は「生」のエイリアスとしてのみ登録
   - 将来的には調理法別のエイリアス（「炒め玉ねぎ」→「油いため」など）の追加を検討

2. **検索ロジックの継続的改善**:
   - ユーザーの入力パターンを分析し、必要に応じてLLMによる文脈判断の導入を検討
   - 表記揺れ対応をさらに強化し、多様な食品名入力に対応する

この修正により、エイリアス検索の優先順位が適切に設定され、より正確な栄養計算が可能になりました。特に複数食品の栄養計算においても、理論値に近い結果が得られるようになっています。

1.  **栄養データ型 標準化・移行ガイドライン**
2.  **移行フェーズ別 実装指示書**
3.  **新栄養計算システム 関連ファイルリスト**

---

## 1. 栄養データ型 標準化・移行ガイドライン

**目的:** このガイドラインは、`manmaru` アプリケーションにおける栄養データ型の標準化方針と、旧型から標準型への段階的な移行プロセスを定義し、開発チーム全体の一貫性と効率性を向上させることを目的とします。

**背景:** これまでの開発で、複数の栄養データ型が混在し、型エラーの増加やコードの一貫性低下といった課題が生じていました。本ガイドラインに基づき、これらの問題を解消します。

**1. 標準データ型:**

*   アプリケーション内部（サービス層、計算ロジック、新規UIコンポーネント等）で標準的に使用する栄養データ型は、**`StandardizedMealNutrition`** (`src/types/nutrition.ts`) とします。
*   **採用理由:**
    *   **構造化と明確性:** 食事全体の総栄養素 (`totalNutrients`) と個々の食品アイテム (`foodItems`) が明確に分離され、データ構造が理解しやすい。
    *   **一貫性のある栄養素表現:** 栄養素データが `Nutrient` 型（名前、値、単位のオブジェクト）の配列で統一され、アクセス方法が一貫し、拡張性も高い。
    *   **再設計目標との整合:** 型定義の不整合解消という目標に合致する。

**2. `NutritionData` の位置づけ:**

*   `NutritionData` (`src/types/nutrition.ts`) は、以下の **限定的な目的** でのみ使用を許可します。
    *   **データベース永続化:** 現在のデータベーススキーマ (`meal_nutrients` テーブル等) との互換性を保つためのデータアクセス層 (リポジトリ等) での読み書き。
    *   **後方互換性:** まだ `StandardizedMealNutrition` 形式に対応していない **旧API** や **旧UIコンポーネント** との境界。
*   **注意:** 新規開発や改修においては、原則として `NutritionData` を直接扱わず、境界で `StandardizedMealNutrition` へ変換してください。

**3. 移行の基本方針:**

*   **段階的移行:** API層 → UI層 → サービス層 の順で段階的に移行を進めます。
*   **標準型の優先:** 新規コードや改修コードでは、可能な限り `StandardizedMealNutrition` を使用します。
*   **境界での変換:** 異なる型を扱う必要がある境界（API、DB、旧コンポーネント）では、必ず型変換ユーティリティを使用します。
*   **型アサーションの排除:** 安易な型アサーション (`as any` や不適切な `as`) は避け、根本的な型エラーの解決を目指します。

**4. 型変換ユーティリティ:**

*   型定義ファイル (`src/types/nutrition.ts`) 内のヘルパー関数は、**`src/lib/nutrition/nutrition-type-utils.ts`** (新規作成) に移動・集約します。
*   主な変換関数:
    *   `convertToStandardizedNutrition`: `NutritionData` → `StandardizedMealNutrition`
    *   `convertToLegacyNutrition`: `StandardizedMealNutrition` → `NutritionData`
    *   `createStandardizedMealNutrition`: `StandardizedMealNutrition` を生成するファクトリ関数 (新規作成推奨)
    *   `createEmptyNutritionData`: エラー時等のフォールバック用 (`NutritionData` 形式)
*   変換が必要な場合は、これらのユーティリティ関数を **必ず利用** してください。独自実装は避けてください。

**5. エラーハンドリング:**

*   エラーは `src/lib/error/types/base-error.ts` の `AppError` を使用して表現します。
*   エラーコードは `src/lib/error/codes/error-codes.ts` の `ErrorCode` を使用します。
*   APIルートでは `src/lib/api/middleware.ts` の `withErrorHandling` を使用し、統一されたエラーレスポンスを返却します。
*   詳細は `docs/guidelines/ERROR_HANDLING.md` を参照してください。型変換時のエラーなども `AppError` で適切に処理してください。

**6. コードレビュー時のチェックポイント:**

*   標準型 (`StandardizedMealNutrition`) が適切に使用されているか。
*   `NutritionData` の使用が限定的な目的に留まっているか。
*   型変換が必要な箇所でユーティリティ関数が正しく使用されているか。
*   不必要な型アサーションがないか。
*   エラーハンドリングがガイドラインに沿っているか。

**7. 質疑応答:**

*   不明点や判断に迷う場合は、リードエンジニアまたはアーキテクチャ担当者に相談してください。

---

## 2. 移行フェーズ別 実装指示書

**全体目標:** アプリケーション全体で `StandardizedMealNutrition` を標準データ型として一貫して使用し、型安全性を高め、保守性を向上させる。

**フェーズ1: 基盤整備とユーティリティ整理 (期間: X週間)**

*   **目標:**
    *   型変換ロジックを専用ファイルに集約する。
    *   標準型を生成するファクトリ関数を実装する。
    *   型定義ファイル (`src/types/nutrition.ts`) を整理する。
    *   比較的容易に修正可能な型エラーを解消する (目標: 50件程度)。
*   **具体的なタスク:**
    1.  `src/lib/nutrition/nutrition-type-utils.ts` を作成する。
    2.  `src/types/nutrition.ts` から `parseNutritionFromJson`, `serializeNutritionToJson`, `convertToNutrientDisplayData` を `nutrition-type-utils.ts` に移動する。
    3.  `nutrition-type-utils.ts` に `createStandardizedMealNutrition` ファクトリ関数を実装する (入力として `Partial<StandardizedMealNutrition>` や `NutritionData` を受け取れるようにする)。
    4.  `src/types/nutrition.ts` 内の不要なコメントや `@deprecated` を整理する。
    5.  `tsconfig.json` の厳格設定 (`exactOptionalPropertyTypes` 等) に起因する型エラーのうち、修正が容易なものを特定し、修正する (例: オプショナルプロパティの明示的な `undefined` チェック追加など)。
*   **完了基準:**
    *   `nutrition-type-utils.ts` が作成され、指定された関数が移動されている。
    *   `createStandardizedMealNutrition` が実装され、ユニットテストが追加されている。
    *   `src/types/nutrition.ts` が整理されている。
    *   目標件数の型エラーが修正され、CIが通る状態である。

**フェーズ2: API境界の標準化 (期間: Y週間)**

*   **目標:**
    *   v2 API エンドポイントの **リクエスト** と **レスポンス** で可能な限り `StandardizedMealNutrition` (またはその一部の型) を使用するように型定義を強化する。
    *   API アダプター (`ApiAdapter` や関連ヘルパー) を活用し、新旧形式の差異を吸収する。
    *   API 境界に関連する型エラーを解消する。
*   **具体的なタスク:**
    1.  `/api/v2/` 以下の各APIエンドポイントのハンドラー関数の入力型・出力型を見直し、`StandardizedMealNutrition` に基づく型定義に修正する (必要に応じて部分型やPick/Omitを利用)。
    2.  Zod スキーマ (`src/lib/validators/` 配下など) も上記に合わせて更新する。
    3.  `src/lib/api/adapter.ts` (または関連ファイル) の変換ロジックが、最新の型定義と整合性が取れているか確認・修正する。特に `convertStandardToLegacy`, `convertLegacyToStandard` 等。
    4.  APIハンドラー、バリデーション、アダプターに関連する型エラーを修正する。
    5.  必要に応じてAPIドキュメント (`docs/api-docs`) を更新する。
*   **完了基準:**
    *   対象となるv2 APIエンドポイントの型定義が更新されている。
    *   APIアダプターの関連コードが修正・検証されている。
    *   API境界に関連する型エラーが解消されている。
    *   既存のAPIテストがすべてパスする。

**フェーズ3: UIコンポーネントの移行 (期間: Z週間)**

*   **目標:**
    *   栄養情報を表示・操作する主要なUIコンポーネントが、Props として `StandardizedMealNutrition` を直接受け取れるように修正する。
    *   UI層での `NutritionData` への依存を減らす。
    *   UIコンポーネントに関連する型エラーを解消する。
*   **具体的なタスク:**
    1.  栄養ダッシュボード、食事記録ページ、栄養サマリーなどの主要コンポーネントを特定する。
    2.  特定したコンポーネントの Props 型定義を `StandardizedMealNutrition` に基づくように変更する。
    3.  コンポーネント内部のロジックを、新しい Props 型に合わせて修正する (例: `totalNutrients.nutrients.find(...)` のようなアクセス方法への変更)。
    4.  `convertToNutrientDisplayData` 等のユーティリティを適切に利用するように修正する。
    5.  UIコンポーネントおよび関連するフック、状態管理ロジックの型エラーを修正する。
*   **完了基準:**
    *   対象となる主要UIコンポーネントの Props と内部ロジックが `StandardizedMealNutrition` ベースに更新されている。
    *   UI表示が以前と変わらず正しく動作することを確認する (手動テストまたはUIテスト)。
    *   UI層に関連する型エラーが解消されている。

**フェーズ4: サービス層・内部ロジックの移行 (期間: W週間)**

*   **目標:**
    *   栄養計算サービス (`NutritionService` など) や関連する内部ロジックが、`StandardizedMealNutrition` を主要なデータ形式として扱うように修正する。
    *   サービス層での `NutritionData` への依存をなくす。
    *   サービス層に関連する型エラーを解消する。
*   **具体的なタスク:**
    1.  `src/lib/nutrition/nutrition-service-impl.ts` (または関連ファイル) 内のメソッドの引数・戻り値の型を `StandardizedMealNutrition` ベースに変更する。
    2.  内部の計算ロジックやデータ処理を、新しい型定義に合わせて修正する。
    3.  データベースアクセス前後での型変換 (`convertToLegacyNutrition`, `convertToStandardizedNutrition` 等の利用) が適切に行われているか確認・修正する。
    4.  サービス層に関連する型エラーを修正する。
    5.  関連するユニットテストを更新・追加する。
*   **完了基準:**
    *   対象となるサービス層のコードが `StandardizedMealNutrition` ベースに更新されている。
    *   サービス層に関連する型エラーが解消されている。
    *   関連するユニットテストがすべてパスする。

**フェーズ5: データベース層の検討 (継続的)**

*   **目標:** 長期的に `NutritionData` への依存を減らすための方策を検討する。
*   **タスク (例):**
    *   `extended_nutrients` JSONB フィールドへの依存度を評価する。
    *   `StandardizedMealNutrition` の構造により近い形でデータを保存する代替スキーマを検討する。
    *   リポジトリパターンなどを導入し、DBアクセス層をより抽象化する。
*   **注意:** このフェーズは直接的なコード修正を伴わない可能性があります。将来的なアーキテクチャ改善のための検討フェーズです。

---

## 3. 新栄養計算システム 関連ファイルリスト

以下は、今回の標準化・移行作業に特に関連性の高いファイルやディレクトリのリストです。作業を進める上で参照・修正の対象となる可能性が高いです。

**型定義:**

*   `src/types/nutrition.ts`: **最重要**。標準型 `StandardizedMealNutrition` と旧型 `NutritionData` が定義されている。
*   `src/types/common.ts`: `Nutrient` 型などが定義されている可能性あり。

**ユーティリティ:**

*   `src/lib/nutrition/nutrition-type-utils.ts`: (新規作成) 型変換関数を集約するファイル。
*   `src/lib/nutrition/nutrition-display-utils.ts`: 表示用の計算ロジック（スコア計算、色取得など）。
*   `src/lib/date-utils.ts`: (関連の可能性) 日付処理。

**エラーハンドリング:**

*   `src/lib/error/types/base-error.ts`: `AppError` クラス定義。
*   `src/lib/error/codes/error-codes.ts`: `ErrorCode` Enum 定義。
*   `src/lib/api/middleware.ts`: `withErrorHandling` ミドルウェア。
*   `docs/guidelines/ERROR_HANDLING.md`: エラーハンドリングガイドライン。

**API関連:**

*   `src/app/api/v2/`: 新しいAPIエンドポイントのハンドラー。
*   `src/lib/api/adapter.ts`: (または類似パス) 新旧API形式の変換アダプター。
*   `src/lib/validators/`: Zod等を用いたリクエストバリデーションスキーマ。
*   `docs/api-docs/`: APIドキュメント。

**サービス層:**

*   `src/lib/nutrition/nutrition-service.ts`: `NutritionService` インターフェース定義。
*   `src/lib/nutrition/nutrition-service-impl.ts`: (または類似パス) 栄養計算等のコアロジック実装。

**データベースアクセス:**

*   `src/lib/supabase/db.ts`: (または類似パス) SupabaseクライアントやDB操作関数。リポジトリパターンが導入されていればその実装ファイル。

**UIコンポーネント (例):**

*   `src/components/home/nutrition-summary.tsx`: ホーム画面の栄養サマリー。
*   `src/app/(authenticated)/dashboard/page.tsx`: ダッシュボードページ。
*   `src/components/meals/meal-form.tsx`: 食事記録フォーム。
*   `src/components/nutrition/nutrient-display.tsx`: 個別の栄養素表示コンポーネント。

**ガイドライン・レポート:**

*   `docs/guidelines/nutrition-type-standardization.md`: **最重要**。本移行の基準となるガイドライン。
*   `docs/reports/`: 過去の開発レポート (コンテキスト理解用)。
*   `docs/個人メモ/栄養素計算新・旧フロー.md`: 新旧システムの比較理解用。



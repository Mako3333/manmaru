# 栄養データ型 標準化ガイドライン

## 1. 背景と目的

栄養素計算システムの再設計プロセスにおいて、複数の栄養データ型（特に `NutritionData` と `StandardizedMealNutrition`）が混在し、開発時の混乱やコードの一貫性の低下を招く可能性が明らかになりました。

このドキュメントは、`manmaru` アプリケーション内で使用する栄養データ型の標準を定義し、型定義の不整合を解消することで、コードの可読性、保守性、および一貫性を向上させることを目的とします。

## 2. 標準データ型: `StandardizedMealNutrition`

アプリケーション内部（サービス層、計算ロジック、新規UIコンポーネント等）で標準的に使用する栄養データ型として、**`StandardizedMealNutrition`** (`src/types/nutrition.ts` 内で定義) を採用します。

**採用理由:**

*   **構造化と明確性:** 食事全体の総栄養素 (`totalNutrients`) と、個々の食品アイテムの詳細 (`foodItems` および `FoodItemNutrition`) が明確に分離されており、データの意図が理解しやすい。
*   **一貫性のある栄養素表現:** すべての栄養素データが `Nutrient` 型（名前、値、単位のオブジェクト）の配列で表現されており、アクセス方法が統一され、拡張性も高い。
*   **再設計の目的との整合性:** 型定義の不整合解消という再設計目標に合致する。
*   **計算ロジックへの適合性:** 食品ごとのデータと全体の合計が分離されているため、栄養計算サービス等での処理に適している。

## 3. `NutritionData` の位置づけ

`NutritionData` (`src/types/nutrition.ts` 内で定義) は、以下の限定的な目的で使用します。

*   **データベースへの永続化:** 現在のデータベーススキーマ（特に `extended_nutrients` フィールド）との互換性を保つため、データベースアクセス層でのデータの読み書き時に使用する場合があります。
*   **後方互換性の維持:** 旧システムや、まだ `StandardizedMealNutrition` 形式に対応していないAPI、UIコンポーネントとの連携時に、一時的なデータ形式として使用する場合があります。

## 4. 開発ガイドライン

1.  **標準型の使用:** 新規に作成する、または既存のコードを改修する際は、原則として **`StandardizedMealNutrition`** を主要なデータ形式として扱ってください。
2.  **境界での型変換:** データベースアクセス層（リポジトリパターンなど）や、旧形式 (`NutritionData`) を必要とするAPI/コンポーネントとの境界部分でのみ、型変換を行ってください。
3.  **型変換関数の利用:** 型変換が必要な場合は、`src/lib/nutrition/nutrition-utils.ts` 内の既存関数 (`convertToLegacyNutrition` など) や、必要に応じて新たに作成する専用の型変換ユーティリティ関数を利用してください。
4.  **段階的な移行:** アプリケーション全体で `StandardizedMealNutrition` が中心的に利用される状態を目指し、`NutritionData` への依存箇所を段階的に減らしていくように努めてください。

## 5. 型定義ファイル内のヘルパー関数について

現在 `src/types/nutrition.ts` 内に存在するヘルパー関数 (`parseNutritionFromJson`, `serializeNutritionToJson`, `convertToNutrientDisplayData`) は、型定義ファイルの責務を超えています。

**推奨:** これらの関数は、別途 `src/lib/nutrition/nutrition-type-utils.ts` のような専用のユーティリティファイルを作成し、そちらへ移動してください。（この作業は別タスクとして計画・実施することを推奨します）

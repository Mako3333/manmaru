はい、承知いたしました。
提供されたガイドラインとコードレビューの結果に基づき、ビルドエラー解消とコード品質向上を目的とした修正指示書を、優先度順に更新します。

---

# 【更新版】manmaru アプリ コード修正指示書

**目的:** ビルドエラーを解消し、TypeScript の型安全性、コードの一貫性、保守性を向上させる。

**参照ガイドライン:** `docs/guidelines/lint_erorr.md` (TypeScript 型統一・リンターエラー対応ガイドライン)

---

## 最優先事項 (ビルドエラー解消 & 型安全性強化)

これらの修正は、ビルドの成功と基本的な型安全性の確保に不可欠です。

1.  **`any` 型の排除 (ガイドライン 2.1, 7)**
    *   **対象ファイル:**
        *   `src/lib/nutrition/nutrition-type-utils.ts` (`convertOldToNutritionData` の引数 `oldData`)
        *   `src/app/(authenticated)/dashboard/page.tsx` (`useState<any[]>`)
        *   `src/lib/api/api-adapter.ts` (複数の関数の引数/戻り値)
        *   `src/lib/api.ts` (一部関数の戻り値など)
        *   その他、`catch (error: any)` を使用している箇所すべて
    *   **修正内容:**
        *   関数の引数/戻り値: `unknown` 型を使用し、関数内部で型ガード (`typeof`, `instanceof`, `in`, ユーザー定義型ガード) を行うか、具体的な型（例: `LegacyNutritionData`）を定義して使用する。
        *   `useState`: 状態が保持する実際のデータ型（例: `NutritionProgress[]`, `ChartData[]`）を指定する。
        *   `catch` ブロック: `catch (error: unknown)` とし、`instanceof Error` や `instanceof AppError` で型を絞り込んでからプロパティにアクセスする。プロジェクト共通の `handleError` 関数の利用を推奨。
    *   **ガイドライン参照:** 2.1, 2.4, 6

2.  **`@ts-expect-error` / `@ts-ignore` の解消 (ガイドライン 3.2, 7)**
    *   **対象ファイル:**
        *   `src/app/api/recipes/clip/recipe-clip-client.tsx` (`convertToStandardizedNutrition` 呼び出し箇所)
        *   `src/lib/services/recipe-service.ts` (`convertToStandardizedNutrition` 呼び出し箇所)
        *   `src/app/api/recommendations/home-recipes/route.ts` (`shuffleArray` 関数内)
    *   **修正内容:**
        *   `convertToStandardizedNutrition` 関連:
            *   `src/lib/nutrition/nutrition-type-utils.ts` の `convertToStandardizedNutrition` 関数の型定義を修正し、受け入れ可能な型（例: `NutritionData | Partial<StandardizedMealNutrition>` など）を正確に反映させる。
            *   または、呼び出し側で入力データを `NutritionData` 型に変換してから渡す。
        *   `shuffleArray` 関連 (`noUncheckedIndexedAccess`):
            *   `!` (non-null assertion) を削除する。
            *   配列アクセス前にインデックスが配列の範囲内にあることを確認するロジックを追加する (`if (shuffled[i] !== undefined && shuffled[j] !== undefined)` など)。
            *   または、一時変数を用いた古典的な要素入れ替え方法に書き換える。
        *   **原則:** `@ts-expect-error` / `@ts-ignore` は削除し、根本的な型エラーを解決する。やむを得ない場合はガイドライン 3.2 に従い理由と解消計画をコメントする。
    *   **ガイドライン参照:** 3.2, 6

3.  **Hooks の依存配列の修正 (ガイドライン 7)**
    *   **対象ファイル:**
        *   `src/app/(authenticated)/dashboard/page.tsx` (`useEffect` 内)
        *   `src/hooks/useAuth.ts` (`handleAuthStateChange` の扱い)
        *   その他、`useEffect`, `useCallback`, `useMemo` を使用している箇所全般
    *   **修正内容:**
        *   ESLint ルール `react-hooks/exhaustive-deps` を有効化し、警告/エラー箇所を特定する。
        *   `useEffect`, `useCallback` 内で使用されているすべての外部変数・関数（state, props, context からの値、カスタムフックの戻り値など）を依存配列に含める。
        *   依存配列に含めたくない関数（再生成されるべきでない、またはメモ化されていない）は `useCallback` でメモ化するか、コンポーネント外で定義する、`useRef` で保持するなどの対策を行う。
        *   オブジェクトや配列は `useMemo` でメモ化するか、依存関係をプリミティブ値にする。
        *   `handleError` のようなユーティリティ関数は、通常コンポーネント外で定義されていれば依存配列に含める必要はないが、コンポーネント内で定義されている場合は `useCallback` でメモ化する。
    *   **ガイドライン参照:** 7 (ESLint), 6 (エラー解決手順)

4.  **Supabase クライアントの統一 (優先度: 高)**
    *   **対象ファイル:**
        *   `src/lib/supabase/client.ts`
        *   その他、`createClient` を直接使用している箇所
    *   **修正内容:**
        *   `src/lib/supabase/client.ts` の `createClient` を削除または非推奨とし、Client Components では `@supabase/ssr` の `createBrowserClient` を、Server Components/Route Handlers では `createServerClient` を使用するように統一する。
        *   `createBrowserClient` は環境変数を直接渡す。
        *   `createServerClient` は `cookies()` ヘルパーと適切な Cookie 操作関数を渡す。
    *   **ガイドライン参照:** (直接の言及はないが、コードレビュー結果に基づく)

5.  **型定義の不整合修正 (API レスポンス) (ガイドライン 2.3, 4, 7)**
    *   **対象ファイル:**
        *   `src/app/api/v2/` 以下の API ルート (`meal/analyze`, `image/analyze`, `recipe/parse` など)
        *   `src/lib/api/api-adapter.ts`
        *   `src/types/api-interfaces.ts`, `src/types/api.ts`
        *   `src/hooks/useApi.ts`
    *   **修正内容:**
        *   API ルートハンドラ:
            *   内部処理では `StandardizedMealNutrition` を使用する。
            *   レスポンスから `legacyNutrition` フィールドを削除する (UI 側の移行完了が前提)。
            *   `createSuccessResponse` / `createErrorResponse` を使用してレスポンス形式を統一する。
        *   `ApiAdapter`:
            *   `convertToStandardNutrition` と `convertToStandardizedNutritionFormat` の役割が重複しているため、`nutrition-type-utils.ts` の関数に統一し、`ApiAdapter` 内の関連メソッドを削除またはリファクタリングする。
            *   `convertStandardToLegacy` は、DB 保存用 (`convertToDbNutritionFormat`) と明確に区別するか、不要であれば削除する。
        *   型定義ファイル: API レスポンス型 (`ApiResponse`, `StandardApiResponse` など) を `StandardizedMealNutrition` を基準に更新し、`legacyNutrition` を削除する。
        *   `useApi` フック: `request` メソッド内の `legacyFormat` フラグと関連する変換ロジックを削除または見直す。`requestV2` をデフォルトとし、`requestLegacy` は非推奨とする。
    *   **ガイドライン参照:** 2.3, 4, 7

---

## 優先度: 高 (コード品質向上)

ビルドエラー解消後、速やかに対応すべき項目です。

1.  **未使用のインポートとコードの削除 (ガイドライン 7)**
    *   **対象ファイル:**
        *   `src/app/api/recipes/[id]/favorite/route.ts`
        *   `src/app/api/recipes/calculate-nutrients/route.ts`
        *   `src/app/api/recommend-recipes/route.ts`
        *   `src/app/api/recipes/save/route.ts`
        *   `src/lib/nutrition/nutrition-service-impl.ts` (`_groupName`)
        *   プロジェクト全体 (ESLint で検出)
    *   **修正内容:**
        *   コメントアウトされた `import` 文や、コード内で参照されていない `import` 文を完全に削除する。
        *   `_groupName` のような未使用変数は、将来的な利用計画が明確でない限り削除する。必要であれば Issue に記録する。
        *   ESLint の `no-unused-vars` や `eslint-plugin-unused-imports` ルールを有効化し、CI でチェックする。
    *   **ガイドライン参照:** 7 (リンティング), 7 (不要コード整理)

2.  **AI システムのインターフェースとパーサー修正 (優先度: 中)**
    *   **対象ファイル:**
        *   `src/lib/ai/ai-service.interface.ts` (`IAIService`)
        *   `src/lib/ai/gemini-response-parser.ts` (`GeminiResponseParser`)
        *   `src/lib/ai/prompts/templates/food-analysis/v1.ts`
    *   **修正内容:**
        *   `IAIService`: 戻り値を `any` や実装依存型から、汎用的な結果型（例: `MealAnalysisResult`, `RecipeAnalysisResult`, `NutritionAdviceResult` from `src/types/ai.ts`）に修正する。
        *   `GeminiResponseParser`: `parseResponse` メソッドを修正し、`food-analysis/v1.ts` プロンプトが要求する `nutrition` フィールドも正しく解析できるようにする。または、`food-analysis/v1.ts` プロンプトから `nutrition` フィールドの要求を削除し、栄養計算は `NutritionService` に完全に任せる。
    *   **ガイドライン参照:** (直接の言及はないが、コードレビュー結果に基づく)

---

## 優先度: 中 (保守性向上)

コードベースの健全性を高めるための項目です。

1.  **`ApiAdapter` の整理・廃止 (ガイドライン 4)**
    *   **対象ファイル:** `src/lib/api/api-adapter.ts` およびその呼び出し元
    *   **修正内容:** 型変換ロジックを `src/lib/nutrition/nutrition-type-utils.ts` に集約し、`ApiAdapter` を削除するか、API 通信に特化したラッパーとしての役割に限定する。
    *   **ガイドライン参照:** 4

2.  **コンポーネント分割の検討**
    *   **対象ファイル:** `src/app/(authenticated)/meals/log/page.tsx` など
    *   **修正内容:** 1 ファイルあたりの行数が多く、複数の責務を持っているコンポーネントを、より小さなコンポーネントやカスタムフックに分割するリファクタリングを検討する。（具体的な分割は別タスクとして計画）
    *   **ガイドライン参照:** (直接の言及はないが、一般的なベストプラクティス)

3.  **ドキュメント更新**
    *   **対象ファイル:** `docs/` 以下の関連ファイル
    *   **修正内容:** 上記の修正内容を反映し、API 仕様、型定義、ガイドラインなどのドキュメントを最新の状態に更新する。
    *   **ガイドライン参照:** 5.1

---

## 全体的な推奨事項

*   **ESLint/Prettier 設定強化:** ガイドライン 7.1, 7.2 に基づき、ルール設定を見直し、`error` レベルのルールを増やすことを検討する。
*   **CI 連携:** ガイドライン 7.3 に基づき、コミットフックと CI パイプラインでリンターと型チェックを必須にする。
*   **コードレビュー:** ガイドライン 5.1, 5.3 に基づき、コードレビュー時に本指示書とガイドラインの遵守状況を確認する。

---

**進め方:**

1.  **最優先事項**から順に着手し、ビルドエラーを解消します。
2.  各修正ごとに、関連するテストを実行し、リグレッションが発生していないか確認します。
3.  小さな単位でコミットし、変更内容を明確に記述します。
4.  優先度「高」「中」の項目についても、可能な範囲で進めます。
5.  不明点や判断に迷う点があれば、チーム内で相談してください。
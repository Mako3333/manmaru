MVP後の対応
================

この問題は、MVPリリース後のリファクタリング・改善フェーズにおける優先度の高いタスクとして、課題管理ツールに正式に登録してください。

解決策の検討
-------------

MVP後に、以下のいずれか、または組み合わせによる根本解決を目指します。

### 共通の型ガード関数/ユーティリティ

context.params を受け取り、期待するパラメータ（例: id）が存在し、string 型であることを検証して返すような関数を作成し、各APIルートで利用する。

### ミドルウェア/ハンドラーラッパーの改善

withAuthAndErrorHandling のようなラッパー関数で、リクエストパスに基づいて context.params の型をより具体的に推論または検証する仕組みを導入する（例: Zod スキーマでパスパラメータも検証する）。

### Next.js の将来的な改善

Next.js 自体の型定義が将来的に改善され、より型安全なパラメータアクセスが可能になる可能性も注視します。

## AI推定栄養価のフォールバック利用 (優先度: 中)

### 背景

画像/テキスト入力時にAIが食品を認識するが、その食品が内部の食品データベース(DB)に存在しない場合がある。現状ではDBに存在しない食品の栄養価は記録されない。

### 目的

DBに食品が見つからない場合に、AIが同時に推定した栄養価（`aiEstimatedNutrition`）をフォールバックとして利用し、記録される栄養情報の網羅性を向上させる。

### 実装方針案

1.  **API (`/api/meals` POST) 修正:**
    *   フロントエンドから、編集後の食品リスト (`editedFoodItems`) に加えて、AIが推定した栄養価 (`aiEstimatedNutrition`) も受け取る。
    *   `NutritionService.calculateNutritionFromNameQuantities` を呼び出し、DBベースの栄養計算結果と、**DBマッチングに失敗した食品名のリスト**を取得する（`calculateNutritionFromNameQuantities` の戻り値修正が必要）。
    *   DBマッチングに失敗した食品名に対応するAI推定栄養価を `aiEstimatedNutrition` から抽出する。
    *   DB計算結果と、抽出したAI推定栄養価を**マージ**して最終的な `StandardizedMealNutrition` を生成する。
    *   マージ後の `StandardizedMealNutrition` をDBに保存する。

2.  **`NutritionService.calculateNutritionFromNameQuantities` 修正:**
    *   戻り値 (`NutritionCalculationResult`) に、DBマッチングに成功した食品と失敗した食品を区別できる情報（例: `matchResults` 配列の各要素に `success: boolean` フラグを追加、または `notFoundFoodNames: string[]` を追加）を含めるように修正する。

3.  **AI推定栄養価 (`aiEstimatedNutrition`) の形式:**
    *   AI (Gemini) が返す `estimatedNutrition` の形式を確認・定義する必要がある。理想的には、認識された食品名ごとに栄養価リスト (`{ foodName: string, nutrients: Nutrient[] }[]` のような形式) が返ってくることが望ましい。現在のプロンプト (`food-analysis/v1.ts` や `text-input-analysis/v1.ts`) の修正が必要になる可能性がある。

4.  **マージロジック:**
    *   DB計算結果とAI推定値のマージ方法を詳細に設計する。
    *   単純な合算ではなく、見つかった食品はDB値、見つからなかった食品はAI推定値を使用する。
    *   量を考慮したスケーリングが必要。AI推定値が100gあたりなどで返ってくる場合、ユーザーが編集した量に合わせてスケーリングする必要がある。
    *   信頼度 (`confidence`) の扱いも考慮する (AI推定値の信頼度は低めにするなど)。

### 検討事項

*   AI推定値の精度と信頼性をどうユーザーに伝えるか。
*   AI推定値とDB計算値が混在する場合のUI表示方法。
*   AIプロンプトの調整による `aiEstimatedNutrition` の形式制御。

## clipped_recipes テーブルの nutrition_per_serving カラム名見直し (優先度: 低)

### 背景

現在 `clipped_recipes` テーブルに存在する `nutrition_per_serving` カラムは、名前から「1人前あたりの栄養価」を示唆するが、実際には「レシピ全体の合計栄養価」が格納されている。これは直感的ではなく、コードを読む際に誤解を招く可能性がある。

### 目的

カラム名を実態に合わせて変更し、コードの可読性と保守性を向上させる。

### 実装方針案

1.  **カラム名変更:**
    *   `nutrition_per_serving` を `total_nutrition` や `recipe_total_nutrition` など、より意味が明確な名前に変更する。
    *   データベースマイグレーションを実行してスキーマを更新する。
2.  **関連コード修正:**
    *   このカラムを参照しているすべてのバックエンドコード（APIルート、サービスなど）を新しいカラム名を使用するように修正する。

### 検討事項

*   既存のデータへの影響。マイグレーションは慎重に行う必要がある。
*   変更範囲の特定。関連するコードを漏れなく修正する必要がある。


## MVP後のリファクタリング・機能改善課題

### レシピ詳細ページ (`/recipes/[id]`) の機能強化

1.  **主要栄養素の表示 (1人前):**
    *   **現状:** カロリーのみ表示されている（またはレシピ全体の合計値が表示されている）。
    *   **改善:** DBから取得したレシピ全体の栄養価 (`nutrition_per_serving`) と元の人数 (`servings`) に基づき、クライアントサイドで**1人前**あたりの主要栄養素（カロリー、タンパク質、鉄分、カルシウム、ビタミンD、葉酸）を計算し、栄養成分セクションに表示する。
    *   **担当コンポーネント:** `src/components/recipes/[id]/recipes-client.tsx`

2.  **材料リストの人数調整機能:**
    *   **現状:** 人数調整機能がない。材料リストはクリップ時の人数分が表示されている。
    *   **改善:** レシピ詳細ページに人数調整用のUI（例: ステッパー、ドロップダウン）を追加する。初期値はクリップ時に取得した人数 (`servings`) とする。
    *   **担当コンポーネント:** `src/components/recipes/[id]/recipes-client.tsx`

3.  **人数調整に応じた材料分量の動的変更:**
    *   **現状:** 材料リストの分量は固定。
    *   **改善:** 上記2の人数調整UIで人数が変更された際、材料リストに表示される各材料の**分量**が、調整後の人数に合わせて**動的に再計算・表示**されるようにする。（例: 元レシピ4人前で卵2個 → UIで2人前に調整 → 卵1個と表示）
    *   **注意:** この機能はクライアントサイドでの表示上の計算処理であり、DBに保存されている元のレシピデータや栄養価には影響しません。分量の再計算には、`QuantityParser` のようなロジックをクライアントサイドで利用可能にするか、簡易的な計算ロジック（数値部分のみスケールするなど）を実装する必要があります。
    *   **担当コンポーネント:** `src/components/recipes/[id]/recipes-client.tsx`

4.  **表示の一貫性:**
    *   栄養成分表示は常に**「1人前あたり」**を基準とする。
    *   材料リストの横には、クリップ時に取得した**元のレシピの人数**（例: 「(4人前)」）を表示しつつ、リスト内の各材料の分量は上記3の**UIで調整された人数**に応じて表示する。


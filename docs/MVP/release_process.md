**前提:**

*   **MVPのゴール:** 妊婦さんが「①食事を簡単に記録でき」「②基本的な栄養バランスを把握でき」「③不足栄養素に基づいた簡単なレシピ提案を受けられる」状態を目指します。安定性とコア機能の実現を最優先します。
*   **リファクタリング:** MVPリリースに不可欠な安定性向上やバグ修正に繋がるリファクタリング（特に型安全性、エラー処理）を優先的に組み込みます。大規模な構造変更（DB完全正規化など）はMVP後とします。
*   **追加機能:** 「設定編集ページ」は基本情報管理としてMVPに含めます。「マイサプリ登録」「ダークモード」はMVP後の拡張とします。

---

## MVPリリース計画 (推定期間: 4-6週間)


### フェーズ 1: 基盤安定化と型定義改善 (1.5週間)

*   **目的:** アプリケーションの安定性を高め、今後の開発効率を向上させるための基礎固め。
*   **タスク:**
    1.  **型定義リファクタリング (コア部分):**
        *   `any` 型の排除: `src/lib/ai/ai-service.interface.ts` など、コード全体で `any` を撲滅し、具体的な型または `unknown` + 型ガードに置き換える (`lint_error.md` 参照)。
        *   型アサーション (`as`) のレビュー/削減: `型定義統一指示書.md` に基づき、特にクリティカルな箇所（APIレスポンス処理、データ変換部など）の `as` を見直し、安全な代替手段（型ガード等）に置き換える。
        *   `NutritionData` -> `StandardizedMealNutrition` 移行 (DBアクセス層): `src/lib/supabase/client.ts` や関連サービスで、DBから取得した `nutrition_data` (JSONB) を `StandardizedMealNutrition` に変換するロジックを実装・適用する。`convertToStandardizedNutrition` を活用・改善する。
        *   型定義の配置整理: `api-interfaces.ts` 内のローカル型定義などを `src/types/` 配下の適切なファイルに移動する。
    2.  **エラーハンドリング統一:**
        *   `AppError` / `ErrorCode` の適用: コード全体で `throw new Error()` を見直し、`AppError` を使用するように統一する。適切な `ErrorCode` を選択する。
        *   `withErrorHandling` / `withAuthAndErrorHandling` の適用確認: 全てのAPIルートでミドルウェアが適用されているか確認・修正する。
    3.  **Supabaseクライアント統一:**
        *   `@supabase/ssr` の `createServerClient` の使用方法を `cookie.md`, `supabase-ssr-migration.md` に沿って統一する（特に Middleware, Route Handler）。
    4.  **DB JSONB構造標準化 (方針決定と基本実装):**
        *   `meals.nutrition_data`, `clipped_recipes.nutrition_per_serving` 等のJSONBカラムに `StandardizedMealNutrition` 形式（またはそれに準ずる構造）でデータを保存する方針を固める。
        *   `convertToDbNutritionFormat` を修正し、`StandardizedMealNutrition` からDB保存用JSONを生成するロジックを実装する。
    5.  **`meal_nutrients` テーブルの扱い決定:**
        *   JSONB標準化に伴い、`meal_nutrients` を廃止するか、維持して同期させるかを決定する。**推奨は廃止**とし、関連トリガー削除と `nutrition_goal_prog` ビューの修正を行う。

### フェーズ 2: コア機能実装と修正 (2週間)

*   **目的:** MVPスコープの主要機能を実装・修正し、一通り動作する状態にする。
*   **タスク:**
    1.  **食事記録フロー安定化:**
        *   写真入力 (`meals/log/page.tsx`): 画像処理、`analyzeMealPhoto` API呼び出し、結果表示（`EnhancedRecognitionEditor` 使用）、保存処理 (`handleSaveRecognition`) を `StandardizedMealNutrition` ベースに修正・安定化させる。
        *   テキスト入力 (`meals/log/page.tsx`): テキスト解析 (`analyzeTextInput` API呼び出し）、食品リスト編集、保存処理 (`handleSaveTextInput`) を `StandardizedMealNutrition` ベースに修正・安定化させる。
        *   保存API (`/api/meals` POST): リクエストで `StandardizedMealNutrition` 形式のデータを受け取り、フェーズ1で実装したDB保存ロジック (`convertToDbNutritionFormat` 経由) を使用するように修正する。
    2.  **栄養管理ダッシュボード基本表示:**
        *   `/dashboard` ページ (`dashboard/page.tsx`): `nutrition_goal_prog` ビューから取得したデータを表示するロジックを修正。`StandardizedMealNutrition` をベースに栄養スコア (`calculateNutritionScore`) や各栄養素の達成率を表示する (`NutritionSummary`, `NutritionChart` コンポーネントを修正・活用)。
        *   `NutritionSummary` コンポーネント (`components/home/nutrition-summary.tsx`) を `StandardizedMealNutrition` を受け取るように修正。
    3.  **設定編集ページ実装:**
        *   `/settings/edit` (または `/profile/edit`) ページを作成。
        *   `/api/profile` (または `/api/settings/profile`) に `PATCH`/`PUT` エンドポイントを追加。
        *   既存のプロフィール情報を表示し、編集・保存できるUIを実装。
    4.  **献立提案機能 (基本):**
        *   `/api/recommend-recipes` (または `/api/recipes/recommend`) エンドポイントを修正・実装。不足栄養素 (`nutrition_goal_prog` 等から特定) を基に、シンプルなロジックまたはAI (`PromptType.RECIPE_RECOMMENDATION` を調整) でレシピIDリストまたは基本情報を返す。
        *   ホーム画面 (`home-client.tsx`) やレシピページ (`recipes/page.tsx`) で、提案されたレシピの簡易表示（タイトル、画像など）を実装 (`RecommendedRecipes` コンポーネント活用）。
    5.  **AI連携部分の修正:**
        *   画像解析プロンプトとパーサーの整合性を取る（例: プロンプトから栄養素要求を削除）。
        *   レシピURL解析の改善（専用パーサー優先、AIフォールバック）。

### フェーズ 3: 統合テストと最終調整 (1-1.5週間)

*   **目的:** 主要機能の結合テスト、バグ修正、パフォーマンス確認、リリース準備。
*   **タスク:**
    1.  **エンドツーエンドテスト:**
        *   ユーザー登録 → プロフィール設定 → 食事記録（写真・テキスト）→ ダッシュボード確認 → レシピ提案確認 → 設定編集 の主要フローをテスト。
    2.  **バグ修正:** テストで見つかった不具合や、既存のIssueを修正。
    3.  **パフォーマンス確認:** 主要画面（ホーム、ダッシュボード、食事記録）の表示速度、API応答時間を確認し、ボトルネックがあれば簡易的な改善を行う。
    4.  **UI/UX微調整:** 全体的なデザインの一貫性、操作性を確認し、軽微な調整を行う。
    5.  **ドキュメント更新:**
        *   APIドキュメント (`docs/API_documents/`) を最新化。
        *   README (`README.md`) を更新。
        *   必要に応じて他のガイドラインも更新。
    6.  **リリース準備:**
        *   本番環境用設定（環境変数など）の確認。
        *   最終ビルド確認 (`npm run build`)。
        *   デプロイ手順の確認。
        *   簡単なリリースノート作成。

---

## 担当割り当て（例）

*   **Frontend Lead/Developer:** フェーズ1(型定義修正)、フェーズ2(UI実装/修正、コンポーネントリファクタリング)、フェーズ3(UIテスト、UI/UX調整)
*   **Backend Lead/Developer:** フェーズ1(エラー処理、Supabaseクライアント、DB方針決定)、フェーズ2(API実装/修正、AI連携修正)、フェーズ3(APIテスト、パフォーマンステスト)
*   **DB/Infra担当 (兼任可):** フェーズ1(DB JSONB標準化実装、`meal_nutrients`対応、`nutrition_goal_prog`修正)、フェーズ3(デプロイ準備)
*   **全員:** フェーズ0(計画)、フェーズ1(型定義レビュー)、フェーズ3(統合テスト、バグ修正、ドキュメント更新)

## リスクと対策

*   **型移行の複雑さ:** `NutritionData` から `StandardizedMealNutrition` への移行は影響範囲が広い。
    *   **対策:** DBアクセス層での変換に集中し、影響範囲を限定する。段階的に進め、テストを徹底する。ペアプログラミングや密なコードレビューを行う。
*   **AI連携の不安定さ:** AIモデルの応答形式の変更や、解析精度の問題。
    *   **対策:** パーサーの堅牢性を高める。エラーハンドリングを強化し、失敗時のフォールバック（例: 手動入力推奨）を用意する。プロンプトを継続的に改善する。
*   **DB変更の影響:** `meal_nutrients` 廃止や `nutrition_goal_prog` 修正による予期せぬ影響。
    *   **対策:** ビューのロジックを慎重にテストする。データ移行が必要な場合はスクリプトを作成し、事前にテスト環境で検証する。
*   **期間超過:** リファクタリングやバグ修正に想定以上の時間がかかる。
    *   **対策:** MVPスコープを厳密に守る。優先度の低いリファクタリングはMVP後に回す。進捗を密に共有し、問題があれば早期に計画を見直す。

## MVPリリース判断基準

以下の基準を満たした場合、MVPとしてリリース可能と判断します。

1.  **コアフローの動作:** ユーザー登録から食事記録（写真/テキスト）、基本的な栄養表示（ダッシュボード）、設定編集までの一連の流れが、致命的なエラーなく動作すること。
2.  **安定性:** 主要機能において、頻繁なクラッシュやデータ不整合が発生しないこと。
3.  **型安全性:** コア部分（栄養計算、DB連携、主要API）において、`any` 型や危険な型アサーションが大幅に削減されていること。
4.  **エラーハンドリング:** 主要なエラーケース（認証エラー、入力エラー、APIエラー）で、ユーザーに分かりやすいフィードバックが表示されること。
5.  **基本データの表示:** ダッシュボードで、その日の主要な栄養素の摂取状況（達成率など）が確認できること。
6.  **レシピ提案（基本）:** 不足栄養素に基づいたレシピのリストが（精度は問わずとも）表示されること。
7.  **設定編集:** ユーザーが基本的なプロフィール情報を編集・保存できること。

---
### 開発効率化のアドバイス

1. 型定義の段階的移行: 影響範囲を考慮し、DBアクセス層での変換を先行実装
2. テスト駆動開発: 特に栄養計算ロジックは単体テストを充実させる
3. コードレビュー強化: 型安全性とエラーハンドリングに焦点を当てる
4. デザインシステムの活用: UIコンポーネントの一貫性を維持
5. AI連携の堅牢化: エラー時のフォールバック処理を充実させる

### 成功指標の定義

1. 型安全性: any型と危険な型アサーションの95%以上削減
2. エラーハンドリング: すべてのAPIエンドポイントで適切なエラー処理実装
3. ユーザー体験: コア機能の完了率99%以上（テスト環境）
4. パフォーマンス: 主要画面の初期ロード時間2秒以内
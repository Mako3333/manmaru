# 型定義 改善フェーズ 指示書

**目的:**
先の調査報告書に基づき、TypeScript の型定義に関する残存課題を解消し、コード全体の型安全性、一貫性、保守性をさらに向上させる。

**参照ドキュメント:**
*   型定義 調査・改善報告書
*   `docs/guidelines/nutrition-type-standardization.md`
*   `docs/guidelines/lint_error.md`

**全体方針:**
*   **型アサーション (`as`) の削減:** 安全性を最優先とし、可能な限り型ガードやより適切な型定義で代替する。
*   **型定義の具体化:** 汎用的な型 (`Array<{...}>` など) を、意味のある具体的なインターフェースや型エイリアスに置き換える。
*   **型定義の整理:** ローカルに定義されている共通利用可能な型を適切な場所に移動し、一元管理を促進する。
*   **レガシー型の依存解消:** DB層以外での `NutritionData` への依存を特定し、将来的な完全排除に向けた準備を進める。

**共通の注意点:**
*   **テスト:** 修正後は必ず関連するテスト (`npm run test` または `yarn test`) を実行し、リグレッションが発生していないことを確認してください。必要であればテストケースを追加・修正してください。
*   **ビルド確認:** 修正後に `npm run build` または `yarn build` を実行し、ビルドエラーが発生しないことを確認してください。
*   **プルリクエスト:** 各タスク完了後、または適切な単位でプルリクエストを作成し、コードレビューを受けてください。
*   **並行作業:** 各タスクは比較的独立していますが、型の配置変更などは影響範囲が広がる可能性があるため、担当者間で連携してください。

---

## タスク詳細

### タスク1: 型アサーション (`as`) のレビューと修正 (最優先)

*   **担当範囲:** コードベース全体。特に報告書で指摘された以下の箇所を中心に確認。
    *   型ガード後のキャスト箇所 (例: `response-validators.ts`, `request-validation.ts`)
    *   `JSON.parse` 結果のキャスト箇所 (例: `gemini-response-parser.ts`)
    *   `src/lib/api/api-adapter.ts` (L110) のキャスト
    *   `src/lib/ai/prompts/version-manager.ts` (L55-58) のキャスト
    *   その他、`as` キーワードで検索して見つかる箇所。
*   **修正方針:**
    1.  各 `as` の使用箇所について、なぜ型アサーションが必要なのか理由を確認する。
    2.  **代替手段の検討:**
        *   より厳密な型ガード (`typeof`, `instanceof`, `in`, ユーザー定義型ガード `isType`) で代替できないか？
        *   関数のシグネチャや変数の型定義を修正することで、アサーションが不要にならないか？
        *   `JSON.parse` の結果は、`zod` などのスキーマバリデーションライブラリを使用して型安全に検証・変換することを検討する。
    3.  **修正:** 代替手段があれば、型アサーションを削除し、より安全なコードに書き換える。
    4.  **やむを得ない場合:** 代替手段がなく、開発者が型の安全性を確信できる場合に限り、`as` の使用を許可する。ただし、その場合は**必ず理由と安全性の根拠をコメントで明記**する (`// 型アサーション: 外部APIの仕様により型が保証されているため` など)。`as any` は原則禁止。
*   **検索キーワード例:** `as ` (スペースを含む), ` as `

### タスク2: 型定義の具体性向上 (中優先度)

*   **担当範囲:** 報告書で指摘された箇所および、同様のパターンが見られる箇所。
    *   `src/lib/nutrition/nutrition-service-impl.ts` (L134, L226, L256, L307, L406 など)
    *   他のサービス層、ユーティリティ関数など。
*   **修正方針:**
    1.  `Array<{ name: string; quantity?: string }>` や `Record<string, number>` のように、構造が明確だが専用の型名が付けられていない箇所を特定する。
    2.  そのデータ構造が表す意味に基づき、適切なインターフェース名または型エイリアス名を定義する (例: `interface FoodNameQuantity { name: string; quantity?: string; }`, `type NutrientTargets = Record<'protein' | 'iron' | ..., number>`)。
    3.  定義した新しい型を使用するように、変数宣言、関数の引数・戻り値などを修正する。
*   **検索キーワード例:** `Array<{`, `Record<string,`

### タスク3: 型定義の配置統一 (中優先度)

*   **担当範囲:**
    *   `src/types/api-interfaces.ts`
    *   上記ファイルから移動した型定義を参照しているファイル。
*   **修正方針:**
    1.  `src/types/api-interfaces.ts` 内でローカルに定義されている `NutritionReliability` と `RecognizedFood` を特定する。
    2.  これらの型定義が、APIインターフェース以外でも利用される可能性のある共通的な概念か判断する。
        *   `NutritionReliability` -> `src/types/nutrition.ts` に移動するのが適切か？ (既存の `StandardizedMealNutrition['reliability']` との統合も検討)
        *   `RecognizedFood` -> `src/types/food.ts` または `src/types/ai.ts` に移動するのが適切か？ (`FoodInputParseResult` との関連も確認)
    3.  適切な共通ファイル (`src/types/` ディレクトリ以下) に型定義を移動する。
    4.  元のファイル (`api-interfaces.ts`) および、移動した型を参照していた他のファイルで、新しい場所からインポートするように修正する (`import { NutritionReliability } from '@/types/nutrition';` など)。
*   **検索キーワード例:** `interface NutritionReliability`, `interface RecognizedFood` (in `api-interfaces.ts`)

### タスク4: 古い型 (`NutritionData`) の依存関係解消に向けた調査 (低優先度/継続)

*   **担当範囲:** コードベース全体。特に `src/types/meal.ts` など。
*   **修正方針 (今回は調査・特定が主):**
    1.  DB永続化層 (`convertToDbNutritionFormat` の呼び出し箇所) **以外**で、依然として `NutritionData` 型が直接参照・使用されている箇所を特定する。
    2.  特に、`src/types/meal.ts` の `Meal` インターフェースの `nutrition_data: NutritionData;` が、他の箇所での `StandardizedMealNutrition` への統一を妨げていないか確認する。
    3.  これらの依存関係を解消するために必要な作業（例: `Meal` 型の `nutrition_data` を `StandardizedMealNutrition` に変更し、関連するDB読み込み処理を修正するなど）をリストアップする。
    4.  **注意:** このタスクは、DBスキーマの変更や広範囲なリファクタリングを伴う可能性があるため、今回は**修正ではなく調査と課題のリストアップ**を主目的とします。具体的な修正は、今後のリファクタリング計画に含めることを検討します。
*   **検索キーワード例:** `NutritionData` (ただし、`nutrition-type-utils.ts` と DB アクセス関連ファイルを除く)

---

## 作業の進め方

*   **ブランチ:** 各担当者は、担当するタスクごとにフィーチャーブランチを作成してください (例: `fix/review-type-assertions`, `refactor/improve-type-specificity`)。
*   **コミット:** 意味のある単位でこまめにコミットしてください。
*   **プルリクエスト:** 作業が完了したら、`develop` ブランチ (またはメインの開発ブランチ) に対してプルリクエストを作成し、コードレビューを受けてください。特に型アサーションの修正については、代替手段がないか、コメントが適切かを重点的に確認してください。
*   **コンフリクト:** 並行作業によりコンフリクトが発生した場合は、関係者間でコミュニケーションを取り、協力して解決してください。
*   **進捗共有:** 定期的に進捗状況を共有し、問題点や判断に迷う点を早期に相談してください。

## 完了条件

*   **タスク1:** コードベース内の `as` 型アサーションがレビューされ、不要なものは削除、必要なものには理由がコメントされていること。
*   **タスク2:** 報告書で指摘された箇所の型定義が、より具体的なインターフェース/型エイリアスに置き換えられていること。
*   **タスク3:** `api-interfaces.ts` 内のローカル型定義が適切な共通ファイルに移動され、参照箇所が更新されていること。
*   **タスク4:** DB層以外での `NutritionData` への依存箇所が特定され、リストアップされていること。
*   全ての修正箇所でビルドエラーが発生しないこと (`npm run build`)。
*   関連するテストが全て成功すること (`npm run test`)。
*   プルリクエストが承認され、マージされていること。

# 栄養素計算システム再設計計画 - サマリー

## 背景と目的

manmaruアプリの栄養素計算システムには複数の課題が存在しています：

- 低確信度のマッチングによる栄養計算の精度低下
- 複数のコードパスに散在する冗長な栄養計算ロジック
- 型定義の不整合と複雑なデータ変換処理
- ユーザーへのフィードバック不足
- 一貫性のないエラー処理と標準化されていないレスポンス形式

これらの問題を根本的に解決し、より正確で理解しやすいシステムを構築するため、基本食品リストを活用した包括的な再設計を行います。

## 再設計の原則

1. **単一責任の原則**: 各コンポーネントは明確に定義された単一の責任を持つ
2. **レイヤード設計**: データアクセス、ドメインロジック、プレゼンテーションの分離
3. **依存性逆転**: 具体的な実装への依存を抽象（インターフェース）に置き換え
4. **データ透明性**: ユーザーに確信度と信頼性を適切に伝達
5. **拡張性**: 将来の機能追加や変更に柔軟に対応できる設計
6. **統一エラーハンドリング**: 標準化されたエラー情報とレスポンス形式の一貫した適用

## 再設計の構成要素

### 1. データ構造と食品リポジトリ

**主要コンポーネント**:
- 食品データ型の再設計
- リポジトリインターフェース
- 基本食品リストリポジトリ実装
- 文字列ユーティリティ

**期待される成果**:
- 食品マッチングの精度向上
- 確信度スコアの信頼性向上
- カテゴリによる管理の強化

### 2. 栄養計算サービス

**主要コンポーネント**:
- サービスインターフェース
- 量の解析ユーティリティ
- 栄養計算サービス実装
- サービスファクトリ

**期待される成果**:
- 栄養計算ロジックの統一
- 食品量解析の正確性向上
- 計算精度の全体的な向上

### 3. 食品マッチング戦略

**主要コンポーネント**:
- マッチングサービスインターフェース
- マッチングサービス実装
- 食品入力解析ユーティリティ
- マッチングフィードバックコンポーネント

**期待される成果**:
- 段階的マッチング戦略の一元化
- 確信度に基づく適切な判断
- マッチング結果の透明性向上

### 4. ユーザーフィードバック機能

**主要コンポーネント**:
- 確信度表示コンポーネント
- 栄養計算信頼性インジケーター
- 食品編集モーダル
- 食品リスト編集コンポーネント

**期待される成果**:
- ユーザーへの透明性の向上
- 低確信度データの明示と修正機能
- ユーザー操作性の向上

### 5. AI連携の改善

**主要コンポーネント**:
- AI応答パーサーインターフェース
- OpenAI応答パーサー実装
- AIサービスインターフェース
- OpenAI APIサービス実装

**期待される成果**:
- AI応答解析の堅牢性向上
- エラーハンドリングの強化
- 複数AI提供者への拡張性

### 6. 統一エラーハンドリングシステム

**主要コンポーネント**:
- ApiErrorクラス
- withAuthAndErrorHandlingラッパー
- validateRequestDataユーティリティ
- 標準化されたレスポンス形式ユーティリティ

**期待される成果**:
- エラー情報の一貫性と詳細度の向上
- API実装の簡素化と重複コードの削減
- デバッグ効率の向上
- エンドユーザーへの適切なエラーメッセージ提供

## 実装フェーズ

1. **フェーズ1**: データ構造と食品リポジトリの実装
2. **フェーズ2**: 栄養計算サービスの実装
3. **フェーズ3**: 食品マッチング戦略の実装
4. **フェーズ4**: ユーザーフィードバック機能の強化
5. **フェーズ5**: AI連携の改善
6. **フェーズ6**: 統一エラーハンドリングシステムの拡張と適用

## マイグレーション戦略

- 段階的な機能移行
- 新旧システムの並行運用期間の設定
- 精度検証とフィードバック収集
- 問題発生時のロールバック計画

## 期待される効果

1. **栄養計算精度の向上**: 適切な食品マッチングと量解析による精度向上
2. **ユーザー信頼性の向上**: 透明性のあるフィードバックと確信度表示
3. **開発効率の向上**: コードの一貫性と保守性の向上
4. **拡張性の確保**: 新機能や新しいAIモデルへの対応が容易に
5. **エラー管理の改善**: 構造化されたエラー情報による問題解決の迅速化

## スケジュール概要

- **計画立案と設計**: 2週間
- **実装フェーズ1-6**: 各フェーズ2週間、計12週間
- **テストとバグ修正**: 2週間
- **段階的マイグレーション**: 4週間
- **完全移行と安定化**: 2週間

**合計予定期間**: 22週間（約5.5ヶ月） 
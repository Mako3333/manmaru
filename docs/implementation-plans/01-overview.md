# 栄養素計算システム再設計計画 - 概要

## 1. 問題の概要

manmaruアプリの栄養素計算システムには以下の根本的な課題が存在します：

1. **低確信度データの採用問題**: 極めて低い確信度スコア(0.25)でも食品マッチングを採用し、警告なく保存
2. **冗長な食品名マッチングロジック**: 複数のマッチング戦略と手動エイリアスマッピングの散在
3. **複数の栄養計算クラスの重複**: 少なくとも4つの異なるクラスが栄養計算ロジックを持ち、一貫性がない
4. **型定義の不整合**: 複数の栄養データ型が混在し、型変換が各所に散在
5. **異常値の検出と補正の不十分さ**: 栄養素値の妥当性チェックと異常値補正が不足
6. **ユーザーへのフィードバック不足**: 栄養計算の不確かさや低確信度マッチングに関する情報提供が不足
7. **AI応答の解析と処理の複雑さ**: AI応答解析ロジックがもろく、エラーハンドリングが不十分
8. **キャッシュ管理の冗長性**: 食品データのキャッシュ管理が複雑で、複数の場所に実装
9. **食品量の解析ロジックの冗長さ**: 食品量の文字列解析が複数の場所に実装され、一貫性がない
10. **プロンプト設計と応答解析の連携不足**: プロンプトの設計と応答解析のロジックの連携が不十分
11. **一貫性のないエラー処理**: 統一されたエラーハンドリングシステムが一部のAPIにのみ適用され、全体的な一貫性がない

## 2. 基本食品リストを活用した解決アプローチ

基本食品リスト（頻出食品）を活用して、以下のアプローチで問題を解決します：

### 2.1 再設計の方針

1. **単一責任の原則の適用**:
   - 各コンポーネントは明確に定義された単一の責任を持つ
   - 栄養計算、食品マッチング、データアクセスを分離

2. **レイヤード設計**:
   - データアクセス層：食品データリポジトリ
   - ドメインロジック層：栄養計算サービス、食品マッチングサービス
   - プレゼンテーション層：ユーザー向けUI/UXコンポーネント

3. **依存性逆転**:
   - 具体的な実装への依存を抽象（インターフェース）に置き換え
   - テスト容易性と拡張性の向上

4. **統一エラーハンドリング**:
   - 構造化されたエラー情報を提供するApiErrorクラスの使用
   - すべてのAPIエンドポイントに共通のエラー処理パターンを適用
   - 標準化されたレスポンス形式による一貫性の確保

### 2.2 基本食品リストの活用

- **食品名マッチングの精度向上**:
  - 人間が食材を入力する際によく使う表現に最適化された基本食品名
  - エイリアス（別名）による表記揺れへの対応
  - カテゴリ分類による食品検索・推奨の強化

- **データ構造の一元化**:
  - 一貫した食品データ構造の採用
  - カテゴリ情報の追加による検索性の向上
  - 国際的に理解しやすいIDの採用（数字コードより「rice-white」など）

## 3. 導入計画の概要

### 3.1 フェーズ分け

1. **フェーズ1**: 新しいデータ構造と食品リポジトリの実装
2. **フェーズ2**: 栄養計算サービスの実装
3. **フェーズ3**: 食品マッチング戦略の実装
4. **フェーズ4**: ユーザーフィードバック機能の強化
5. **フェーズ5**: AI連携の改善
6. **フェーズ6**: 統一エラーハンドリングシステムの拡張と適用

### 3.2 マイグレーション戦略

- 既存システムと新システムを並行して動作させる
- 段階的に機能を新システムに移行
- 精度検証とデータ比較による品質保証
- 完全移行後に旧コードを除去

各フェーズの詳細な実装計画は、以下のセクションで説明します。 
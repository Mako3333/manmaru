# 型定義統一（NutritionData → StandardizedMealNutrition）リファクタリング計画書

## ステップ0: 現状分析と準備

**目的**: 移行範囲を把握し、作業の基盤を整える

### 指示文

```
1. 使用箇所の全体マッピング
   $ grep -r "NutritionData\|NutrientData" --include="*.ts" --include="*.tsx" ./src > nutrition-types-usage.txt

2. カテゴリ別に使用箇所を整理（VSCodeなどで以下のパターンを検索）
   a. 型宣言: `type ... NutritionData` `interface ... NutritionData`
   b. Propsの受け渡し: `props: { nutrition: NutritionData`
   c. React状態: `useState<NutritionData>`
   d. 関数の引数・戻り値: `function ...(nutrition: NutritionData)`
   e. APIレスポンス: `return { nutrition: ...` `data: { nutrition: ...`
   f. DB操作: `.insert({ nutrition_data: ...` `.update({ nutrition_data: ...`

3. nutrition-type-utils.tsの関数を検証
   - convertToStandardizedNutrition が全ての主要栄養素をマッピングしているか
   - convertToLegacyNutrition がDB保存に必要な全フィールドを生成しているか
   - extended_nutrients の処理が適切か

4. 既存テストの状態を確認
   - __tests__/lib/nutrition/nutrition-type-utils.test.ts の動作確認
   - nutrition関連のモックデータの構造確認
```

### チェック項目

- [x] 使用箇所リスト（nutrition-types-usage.txt）が作成されている
- [x] カテゴリ別の影響箇所が文書化されている（影響度の高い順にソート）
- [x] `convertToStandardizedNutrition`と`convertToLegacyNutrition`の機能検証が完了している
- [ ] 必要に応じて変換関数の修正・機能強化が行われている
- [x] 既存テストが通ることを確認している
- [ ] 移行戦略のレビューが完了している（チームメンバーと共有）

## ステップ1: コアロジック（サービス層）の統一

**目的**: 栄養計算の中核となるサービス層でStandardizedMealNutritionを使用するよう統一

### 指示文

```
1. NutritionServiceインターフェースの更新（src/lib/nutrition/nutrition-service.ts）
   - 全メソッドの引数・戻り値をStandardizedMealNutritionベースに修正
   - (例) calculateSingleFoodNutrition の戻り値を { nutrition: StandardizedMealNutrition, confidence: number } に統一

2. NutritionServiceImpl実装の更新（src/lib/nutrition/nutrition-service-impl.ts）
   - 内部変数や計算ロジックをStandardizedMealNutritionで扱うよう修正
   - 特に以下のメソッドに注目:
     a. calculateNutrition
     b. calculateSingleFoodNutrition 
     c. evaluateNutritionBalance
     d. identifyDeficientNutrients
     e. calculateNutritionFromNameQuantities

3. nutrition_display_utils.tsの関数を修正
   - StandardizedMealNutritionから栄養素を取得・表示するユーティリティを強化
   - 特に totalNutrients 配列から特定栄養素を検索する関数を追加

4. テストの修正（__tests__/lib/nutrition/nutrition-service-impl.test.ts）
   - テストケースの入力・期待値をStandardizedMealNutrition形式に更新
   - モックや検証ロジックを新しい型に対応させる
```

### チェック項目

- [ ] NutritionServiceインターフェースの全メソッドがStandardizedMealNutritionを使用している
- [ ] NutritionServiceImplの実装がStandardizedMealNutritionを内部的に使用している
- [ ] getNutrientValue(nutrient, nutrients)などのヘルパー関数が追加されている
- [ ] evaluateNutritionBalanceなどの計算関数が新しい型構造で動作する
- [ ] テストが正常に実行され、全てのアサーションが成功する
- [ ] コンソールに型エラーが出力されていない

## ステップ2: データアクセス層（境界）の変換実装

**目的**: データベースとの境界での型変換を整備し、DB操作を安全に行う

### 指示文

```
1. Supabaseクライアント周辺の修正（src/lib/supabase/client.ts）
   - データ取得時の変換処理を追加
     ```typescript
     // 変更前
     const { data } = await supabase.from('meals').select('*');
     return data;
     
     // 変更後
     const { data } = await supabase.from('meals').select('*');
     return data.map(meal => ({
       ...meal,
       nutrition_data: convertToStandardizedNutrition(meal.nutrition_data)
     }));
     ```

2. MealServiceの修正（src/lib/services/meal-service.ts）
   - getMealsByDate等の取得メソッドで、DBから取得したデータを変換
   - saveMealWithNutrition等の保存メソッドで、保存前にStandardizedMealNutritionをDBフォーマットに変換

3. RecipeServiceの修正（src/lib/services/recipe-service.ts）
   - レシピの栄養データ関連処理を同様に更新

4. テストの更新
   - Supabaseモックを更新（取得データと送信データの構造変更）
   - MealServiceとRecipeServiceのテストケースを更新
```

### チェック項目

- [ ] データ取得時にconvertToStandardizedNutritionが適用されている
- [ ] データ保存時にconvertToLegacyNutritionが適用されている
- [ ] MealServiceの全メソッドがStandardizedMealNutritionで動作する
- [ ] RecipeServiceの関連メソッドが更新されている
- [ ] モックデータがDB構造とメモリ内構造の違いを反映している
- [ ] テストが正常に実行され、全てのアサーションが成功する

## ステップ3: UIコンポーネントの移行

**目的**: フロントエンドUIコンポーネントがStandardizedMealNutritionを使用するよう修正

### 指示文

```
1. 主要コンポーネントのProps型定義を更新
   - src/components/nutrition/NutritionDataDisplay.tsx
   - src/components/nutrition/nutrition-summary.tsx
   - src/components/meals/recognition-editor.tsx
   - src/components/dashboard/nutrition-chart.tsx
   - src/components/home/nutrition-summary.tsx

2. 各コンポーネント内の栄養データアクセスコードを修正
   変更例:
   ```typescript
   // 変更前
   const calories = nutrition.calories;
   const protein = nutrition.protein;
   
   // 変更後
   const calories = nutrition.totalCalories;
   const protein = nutrition.totalNutrients.find(n => n.name === 'タンパク質')?.value ?? 0;
   ```

3. React状態管理の更新
   - useState<NutritionData>をuseState<StandardizedMealNutrition>に変更
   - useEffectなどでの依存配列も必要に応じて更新

4. ページコンポーネントの更新
   - src/app/(authenticated)/meals/log/page.tsx
   - src/app/(authenticated)/dashboard/page.tsx
   - src/app/(authenticated)/recipes/*/page.tsx

5. Storybookストーリーの更新
   - nutrition-summary.stories.tsx等のモックデータを更新
```

### チェック項目

- [ ] 全ての関連UIコンポーネントのProps型定義が更新されている
- [ ] 栄養素へのアクセスコードがtotalNutrients配列パターンに修正されている
- [ ] React状態の型定義がStandardizedMealNutritionに更新されている
- [ ] UIが以前と同様に正しく表示される（見た目の変化がない）
- [ ] Storybookストーリーが正常に表示される
- [ ] コンソールに型エラーや実行時エラーが出力されていない

## ステップ4: APIレスポンスの整理

**目的**: API境界で一貫してStandardizedMealNutritionを使用し、後方互換性コードを整理

### 指示文

```
1. API Route Handlerを更新
   - src/app/api/v2/meal/analyze/route.ts
   - src/app/api/v2/meal/text-analyze/route.ts
   - src/app/api/v2/recipe/parse/route.ts
   - src/app/api/v2/food/parse/route.ts
   - src/app/api/meals/*/route.ts

2. レスポンス生成の修正
   - 後方互換用のlegacyNutritionフィールドを削除（UIコンポーネントの移行が完了した場合）
   変更例:
   ```typescript
   // 変更前
   return createSuccessResponse({
     foods: foods,
     nutritionResult: {
       nutrition: convertToStandardizedNutrition(nutritionResult.nutrients),
       legacyNutrition: nutritionResult.nutrients
     }
   });
   
   // 変更後
   return createSuccessResponse({
     foods: foods,
     nutritionResult: {
       nutrition: nutritionResult.nutrition // すでにStandardizedMealNutrition型
     }
   });
   ```

3. フロントエンドのAPI呼び出し部分の修正
   - src/lib/api.ts
   - src/hooks/useApi.ts
   - src/hooks/useNutrition.ts
   - src/hooks/useMeals.ts

4. APIインターフェース型定義の更新
   - src/types/api-interfaces.ts
   - src/types/api.ts
```

### チェック項目

- [ ] 全てのAPIルートハンドラがStandardizedMealNutritionを返す
- [ ] legacyNutritionフィールドが削除されている（または必要な場合は明示的に残している）
- [ ] API呼び出しフックがStandardizedMealNutritionを扱うよう更新されている
- [ ] APIインターフェース型定義が更新されている
- [ ] アプリケーションがAPIを通じて正常に栄養データを取得・表示できる
- [ ] コンソールに型エラーやAPI呼び出しエラーが出力されていない

## ステップ5: 不要な型・関数の削除

**目的**: リファクタリング完了後、不要になった型定義や関数を安全に削除

### 指示文

```
1. 未使用の型定義を削除（src/types/nutrition.ts）
   - NutritionData（完全に移行後）
   - NutrientData
   - OldNutritionData
   - 古い型を参照する型エイリアスやインターフェース

2. 不要になった変換関数を削除（src/lib/nutrition/nutrition-type-utils.ts）
   - convertToLegacyNutrition（DBスキーマ変更後）
   - mapNutrientToNutritionData
   - mapNutritionToNutrientData
   - その他、不要になった関数

3. サンプルデータや定数の更新
   - src/lib/nutrition/constants.ts
   - サンプルデータを生成するユーティリティ
```

### チェック項目

- [ ] 全てのコードがStandardizedMealNutritionに完全に移行されていることを確認
- [ ] 古い型や関数への参照が完全に削除されている
- [ ] 削除する型や関数が他の場所で使われていないことを確認している
- [ ] 削除後にビルドエラーが発生しない
- [ ] テストが正常に実行される
- [ ] アプリケーションが正常に動作する

## ステップ6: 文書とコメントの更新

**目的**: コードとドキュメントの整合性を確保し、将来の開発者のための説明を更新

### 指示文

```
1. 型定義のJSDocコメントを更新
   - StandardizedMealNutritionのドキュメント整備
   - 各栄養素プロパティの単位や解釈を明記
   
2. プロジェクトドキュメントの更新
   - docs/guidelines/nutrition-type-standardization.md
   - APIドキュメント
   - その他の技術文書

3. READMEや開発ガイドの更新
   - データモデルの説明
   - 新規コンポーネント開発時のガイドライン

4. コードコメントの見直し
   - 古い型への言及を更新
   - 複雑な処理への説明追加
```

### チェック項目

- [ ] StandardizedMealNutritionの型定義に詳細なJSDocコメントが追加されている
- [ ] ドキュメントが実装と一致するように更新されている
- [ ] レガシー型への言及が適切に修正されている
- [ ] 新規開発者向けの型使用ガイドラインが更新されている
- [ ] 主要な処理やAPIに適切なコメントが追加されている

## ステップ7: （オプション）DB スキーマ変更と最適化

**目的**: データベーススキーマをStandardizedMealNutritionの構造に合わせて最適化

### 指示文

```
注: このステップは他の変更が安定した後で実施してください。

1. 新しいDBスキーマの設計
   - meals.nutrition_data（現在のJSONB）をより構造化したカラムに分解する案の検討
   - meal_nutrients テーブルの最適化

2. マイグレーションスクリプトの作成
   - Supabase migrationの作成
   - 既存データの変換スクリプトの準備

3. データアクセス層の修正
   - 新しいスキーマに対応するようにクエリを修正
   - 型変換ロジックの簡素化または削除

4. テストとデバッグ
   - 開発環境でのマイグレーションテスト
   - パフォーマンス検証
```

### チェック項目

- [ ] 新しいDBスキーマの設計が完了している
- [ ] マイグレーションスクリプトが作成・テストされている
- [ ] データアクセス層がスキーマ変更に対応している
- [ ] 既存機能が新しいスキーマでも正常に動作する
- [ ] パフォーマンスが改善されているか検証されている

---

## 全体チェックリスト

### リファクタリング前の確認事項

- [ ] 作業ブランチが最新のmainから作成されている
- [ ] 不要な変更がないことを確認（git statusで確認）
- [ ] テストが現時点で全て通っている（npm test）
- [ ] CI/CDパイプラインが正常に動作している

### 進行中の確認事項

- [ ] 各ステップごとに小さなコミットを作成している
- [ ] コミットメッセージが明確で変更内容を説明している
- [ ] 作業の区切りごとにテストを実行している
- [ ] 型エラーをその場で修正している
- [ ] UIの視覚的な変化がないことを確認している

### リファクタリング完了時の確認事項

- [ ] 全てのTypeScriptエラーが解消されている
- [ ] 全てのテストが通っている
- [ ] ESLint警告が最小限に抑えられている
- [ ] アプリケーションが全ての機能テストをパスしている
- [ ] ドキュメントが更新されている
- [ ] コードレビューが完了している

## 注意事項とリスク管理

1. **バックアップ**: 作業前にコードベースとデータベースのバックアップを取得しておく
2. **段階的移行**: 一度に全ての変更を適用せず、機能単位での動作確認を繰り返す
3. **並行稼働**: 古い実装と新しい実装を一定期間並行させ、リグレッションを早期に発見する
4. **ロールバック計画**: 問題発生時のロールバック手順を事前に整理しておく
5. **ステークホルダー通知**: 大きな変更の前後には関係者に通知し、テスト協力を依頼する

このリファクタリング計画書を活用して、段階的かつ安全に型定義の統一を進めてください。
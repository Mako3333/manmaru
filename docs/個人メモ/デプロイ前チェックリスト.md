# まんまるプロジェクト デプロイ前チェックリストと修正案


## 1. デプロイ前チェックリスト

### 1.1 MVPコア機能の完成度確認
- [ ] 食事記録（写真/テキスト両方）のエンドツーエンドフロー検証
- [ ] レシピ推奨機能と栄養データの連携確認
- [ ] ユーザー認証とプロフィール設定の動作確認
- [ ] 栄養ダッシュボードの表示最適化

### 1.2 技術的検証
- [ ] API応答エラー処理の網羅性確認（特にGemini API連携部分）
- [ ] Supabase RLSポリシーの適用確認
- [ ] モバイルデバイスでのレスポンシブ対応
- [ ] Next.js 15.2.0固有の最適化（App Routerパターン）
- [ ] PWA基本対応（manifest.jsonとサービスワーカー）

### 1.3 UX/UIファイナライズ
- [ ] ローディング状態の一貫した表示
- [ ] エラーメッセージの日本語対応
- [ ] タッチ操作の最適化（ボタンサイズ、間隔）
- [ ] 初回ユーザー向けオンボーディング導線

### 1.4 パフォーマンス最適化
- [ ] 画像最適化（next/imageの適切な使用）
- [ ] API応答のキャッシュ戦略実装
- [ ] 大きなコンポーネントの遅延ロード

## 2. 優先度高めの修正案

### 2.1 栄養計算・検索精度の安定化
最新レポートで改善された栄養計算エンジンとエイリアス検索機能を、本番環境でも安定して動作させるための対策:

```typescript
// src/lib/nutrition/database.ts のキャッシュ戦略強化
private async ensureFoodDataLoaded(): Promise<void> {
  const cacheKey = 'food_database_cache';
  const cacheExpiry = 30 * 60 * 1000; // 30分
  
  // キャッシュチェックを強化し、失効状態も確認
  const cachedData = localStorage.getItem(cacheKey);
  const cacheTimestamp = localStorage.getItem(`${cacheKey}_timestamp`);
  const isCacheValid = cachedData && cacheTimestamp && 
    (Date.now() - parseInt(cacheTimestamp)) < cacheExpiry;
  
  if (isCacheValid) {
    try {
      this.foodDatabase = JSON.parse(cachedData);
      return;
    } catch (e) {
      console.warn('キャッシュデータの解析に失敗しました。再取得します。');
    }
  }
  
  // データ取得とエラーハンドリング強化
  try {
    // データ取得ロジック...
    
    // 取得成功時のキャッシュ更新
    localStorage.setItem(cacheKey, JSON.stringify(this.foodDatabase));
    localStorage.setItem(`${cacheKey}_timestamp`, Date.now().toString());
  } catch (error) {
    console.error('Supabaseからの食品データ取得に失敗:', error);
    // フォールバックメカニズム
    this.useFallbackDatabase();
  }
}
```
### 2.2 マイサプリの登録と「サプリを飲んだ」記録機能の追加

妊娠中のサプリメント摂取管理は重要な栄養管理要素です。特に葉酸、鉄分、カルシウム、ビタミンDなどのサプリメントを追跡する機能をMVP前に追加することを推奨します：

#### データベース拡張
```sql
-- マイサプリテーブル
CREATE TABLE user_supplements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  brand TEXT,
  nutrition_data JSONB NOT NULL, -- 栄養素情報
  dosage TEXT,                    -- 用量情報
  frequency TEXT,                 -- 推奨頻度
  image_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- サプリ摂取記録テーブル
CREATE TABLE supplement_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  supplement_id UUID NOT NULL REFERENCES user_supplements(id) ON DELETE CASCADE,
  log_date DATE NOT NULL DEFAULT CURRENT_DATE,
  log_time TIME NOT NULL DEFAULT CURRENT_TIME,
  dosage_taken NUMERIC NOT NULL DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLSポリシー設定
ALTER TABLE user_supplements ENABLE ROW LEVEL SECURITY;
ALTER TABLE supplement_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ユーザーは自分のサプリのみ参照可能" 
ON user_supplements FOR ALL 
USING (auth.uid() = user_id);

CREATE POLICY "ユーザーは自分のサプリ記録のみ参照可能" 
ON supplement_logs FOR ALL 
USING (auth.uid() = user_id);
```

#### UI/UX設計
1. **マイサプリ登録画面**
   - サプリ名、ブランド、画像アップロード機能
   - 1回あたりの栄養素情報入力（葉酸○○μg、カルシウム○○mgなど）
   - 頻度設定（毎日1回、朝晩2回など）

2. **サプリ摂取記録コンポーネント**
   - ホーム画面に「今日のサプリ」カード追加
   - 登録済みサプリのチェックリスト表示
   - ワンタップでサプリ摂取記録

3. **栄養ダッシュボード連携**
   - サプリからの栄養摂取を日次栄養摂取に合算
   - サプリ由来の栄養素は視覚的に区別

#### 実装フロー
1. データベース拡張の実施
2. APIエンドポイント追加
   - `/api/supplements/register`
   - `/api/supplements/log`
   - `/api/supplements/user`
3. コンポーネント実装
   - `components/supplements/my-supplements.tsx`
   - `components/supplements/supplement-log.tsx`
   - `components/home/today-supplements.tsx`
4. 栄養計算ロジックの拡張

#### モバイルUX最適化
- サプリ記録のリマインド通知
- ホーム画面からのクイックアクセス
- 視覚的なサプリ摂取達成表示（ストリーク/連続記録など）

この機能追加により、食事だけでなくサプリメントからの栄養摂取も包括的に管理でき、特に妊婦に重要な葉酸などの栄養素摂取状況をより正確に把握できるようになります。

### 2.3 初回ユーザー体験の改善
新規ユーザーの初回体験を改善し、オンボーディングをスムーズにする:

- ホーム画面に「はじめての方へ」セクション追加
- プロフィール登録時の妊娠週数/出産予定日の入力補助
- 食事記録の簡易ガイド実装

### 2.3 エラーハンドリングの強化
特にAI連携部分のエラーハンドリングを強化:

```typescript
// src/lib/ai/ai-service.ts のエラーハンドリング改善
async analyzeImage(imageData: string, mealType: string): Promise<AnalysisResult> {
  try {
    // 既存の処理...
  } catch (error) {
    // エラー詳細のログ記録
    console.error('画像解析エラー詳細:', JSON.stringify(error, null, 2));
    
    // エラータイプに応じた分岐
    if (error.message?.includes('RESOURCE_EXHAUSTED')) {
      throw new AIError('APIリクエスト上限に達しました。しばらく経ってからお試しください。', 'RATE_LIMIT');
    } else if (error.message?.includes('INVALID_ARGUMENT')) {
      throw new AIError('画像の形式が正しくありません。別の画像をお試しください。', 'INVALID_IMAGE');
    } else if (error.message?.includes('DEADLINE_EXCEEDED')) {
      throw new AIError('応答に時間がかかりすぎています。ネットワーク接続を確認してください。', 'TIMEOUT');
    }
    
    // デフォルトエラー
    throw new AIError('画像の解析中にエラーが発生しました。もう一度お試しください。', 'UNKNOWN');
  }
}
```

## 3. 今後のリリース改善案

### 3.1 パフォーマンスモニタリング導入
本番環境でのパフォーマンスを監視する仕組みを導入:

- Next.js Analytics設定
- クライアントサイドのパフォーマンスメトリクス収集
- API応答時間モニタリング

### 3.2 スケーラビリティ対策
ユーザー増加に備えたスケーラビリティ対策:

- Supabaseクエリの最適化
- 重い処理の非同期化
- 画像処理の最適化

### 3.3 拡張機能の準備
MVPリリース後の拡張機能の準備:

- 家族構成管理機能
- 献立週間計画機能
- 食材在庫管理連携
- push通知機能

## 4. 具体的なデプロイ前チェック手順

1. **環境変数の確認**
   - Supabase接続情報
   - Gemini API設定
   - Next.js環境設定

2. **クロスブラウザテスト**
   - モバイル（iOS/Android）
   - デスクトップ（Chrome/Safari/Firefox）

3. **セキュリティ確認**
   - API露出点のセキュリティ
   - ユーザーデータ保護
   - 認証フロー

4. **PWA対応確認**
   - manifest.jsonの正確性
   - アイコンセットの完全性
   - オフライン動作の基本確認


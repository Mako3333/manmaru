# テキスト入力解析APIの仕組み分析

テキスト入力解析の処理フローを確認しました。以下にその仕組みと主要コンポーネントの役割を説明します。

## 1. APIエンドポイント (src/app/api/analyze-text-input/route.ts)
- **役割**: 食品テキスト入力を受け取り、AIによる解析を行います。
- **リクエスト形式**:
  - **バリデーション**: Zodスキーマを使用して入力データを検証
  - **エラーハンドリング**: withErrorHandling関数でラップされ、例外を適切なHTTPレスポンスに変換

## 2. AIサービス (src/lib/ai/ai-service.ts)
- **役割**: シングルトンパターンで実装された中核サービスで、AIモデルとの通信を担当します。
- **analyzeTextInputメソッド**:
  - 食品データをテキスト形式に変換（例: りんご 1個、バナナ 2本）
  - プロンプトサービスからテンプレートを取得
  - AIモデルを呼び出し
  - レスポンスをJSONとしてパース・検証
  - **エラーハンドリングとバックアップ**:
    - JSONパースエラー時は栄養データベースを使ったフォールバック処理
    - 結果の信頼性向上のため栄養データベースでの計算結果も併用
- **parseJSONResponseメソッド**:
  - レスポンスからJSON部分を抽出（コードブロック内または直接JSON）
  - JSONをパース
  - 必須フィールドの存在確認
  - Zodスキーマによる検証

## 3. プロンプトサービス (src/lib/ai/prompts/prompt-service.ts)
- **役割**: プロンプトテンプレートの管理と生成を担当します。
- **機能**:
  - テンプレート管理: バージョン管理されたプロンプトテンプレートを登録・取得
  - テンプレートレンダリング: 変数を埋め込んでプロンプトを生成

## 4. テキスト入力解析プロンプト (src/lib/ai/prompts/templates/text-input-analysis/v1.ts)
- **役割**: AIに対する指示内容を定義しています。
- **主な指示**:
  - 食品名を標準的な日本語名に変換
  - 曖昧な量を具体的な数値に変換（例: 「少し」→「30g」）
  - 一般的な分量を推測（例: 「りんご」→「りんご 150g（中1個）」）

## 5. AIモデルファクトリー (src/lib/ai/model-factory.ts)
- **役割**: AIモデルの生成と設定を担当します。
- **使用モデル**: Gemini 2.0 Flash
- **設定オプション**: 温度、最大トークン数、topK、topPなどのパラメータ
- **インターフェース**: 統一されたinvokeメソッドを提供

## 6. 栄養データベース (src/lib/nutrition/database.ts)
- **役割**: 食品データの検索と栄養計算を行います
- **主要メソッド**:
  - **findFoodByName**: 食品名から栄養データを検索
  - **calculateNutrition**: 食品リストから栄養データを計算
- **AIサービスとの連携**:
  - AI解析結果のバックアップとして機能
  - 検索精度向上のための補完情報を提供

## 7. エラー処理 (src/lib/errors/ai-error.ts, src/lib/errors/error-utils.ts)
- **役割**: エラーの定義と処理を担当します。
- **エラータイプ**: 様々なエラーコードを定義（検証エラー、AIモデルエラーなど）
- **エラーレスポンス**: 適切なHTTPステータスコードとエラー詳細を含むレスポンス

## 処理フロー概要
1. クライアントから食品リストを受信
2. 入力データを検証
3. AIサービスのテキスト解析メソッドを呼び出し
4. プロンプトを生成してAIモデルに送信
5. AIからのレスポンスをパース・検証
   - エラー時は栄養データベースを使用してフォールバック処理
   - 正常時も栄養データベースで補完計算を実施
6. 結果をクライアントに返却

## 改善点と対策
- **エラーハンドリングの強化**: 
  - AIモデルからの応答形式異常時に栄養データベースを活用したフォールバック処理
  - 必須フィールド（foods）が存在しない場合の自動補完
- **データ品質向上**:
  - 栄養データベースの情報でAI応答を補完
  - 信頼度スコアを元に最適な情報を選択

この仕組みにより、ユーザーが入力した食品テキストを、より標準化された形式に変換し、量の情報を補完することができます。また、AIからの応答に問題があっても安定して結果を返せるようになっています。
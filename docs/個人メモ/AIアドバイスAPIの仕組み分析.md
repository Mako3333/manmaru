# AIアドバイスAPIの仕組み分析

AIアドバイスAPIの処理フローを確認しました。以下にその仕組みと主要コンポーネントの役割を説明します。

## 1. APIエンドポイント (src/app/api/nutrition-advice/route.ts)
- **役割**: ユーザーの栄養状態に基づいたアドバイスを生成・取得します。
- **リクエスト形式**:
  - **GET**: 既存のアドバイスを取得または新規生成
  - **PATCH**: アドバイスの既読状態を更新
- **パラメータ**:
  - **mode**: "summary"（要約）または "detailed"（詳細）
  - **force**: "true"の場合、既存のアドバイスがあっても新規生成
- **エラーハンドリング**: 認証エラー、プロフィール未設定エラーなどを適切に処理

## 2. 認証・ユーザー情報取得
- **役割**: ユーザー認証とプロフィール情報の取得を担当します。
- **処理内容**:
  - Supabaseクライアントからセッション情報を取得
  - ユーザーIDを抽出
  - プロフィール情報（出産予定日など）を取得
  - 妊娠週数とトライメスターを計算

## 3. 栄養状態分析
- **役割**: ユーザーの栄養摂取状況を分析し、不足している栄養素を特定します。
- **処理内容**:
  - 栄養進捗データをデータベースから取得
  - 各栄養素の摂取率を計算
  - 基準値（70%）未満の栄養素を「不足」と判定
  - 基準値以上の栄養素を「十分」と判定
  - データがない場合はデフォルト値を使用

## 4. AIサービス連携 (src/lib/ai/ai-service.ts)
- **役割**: AIモデルとの通信を担当し、アドバイスを生成します。
- **getNutritionAdviceメソッド**:
  - 妊娠週数、トライメスター、季節、不足栄養素などの情報を基にプロンプトを生成
  - AIモデルを呼び出し
  - レスポンスをパース・検証
  - 構造化されたアドバイスデータを返却

## 5. データベース操作
- **役割**: 生成されたアドバイスの保存と取得を担当します。
- **処理内容**:
  - 新規アドバイスをdaily_nutri_adviceテーブルに保存
  - 既存アドバイスの取得
  - アドバイスの既読状態の更新

## 6. エラー処理
- **役割**: エラーの定義と処理を担当します。
- **エラータイプ**:
  - 認証エラー: ユーザーが認証されていない場合
  - プロフィールエラー: 妊婦プロフィールが見つからない場合
  - AIエラー: アドバイス生成時のエラー
- **エラーレスポンス**: 適切なHTTPステータスコードとエラー詳細を含むレスポンス
  - プロフィールエラー時はプロフィール作成ページへのリダイレクト情報を含む

### プロフィールエラー処理の詳細
- **エラー検出**: `profiles`テーブルからユーザーIDに紐づくプロフィールが取得できない場合
- **レスポンス形式**:
  ```json
  {
    "error": "妊婦プロフィールが見つかりません",
    "message": "プロフィールを作成してください",
    "redirect": "/profile"
  }
  ```
- **クライアント側の処理**:
  - エラーレスポンスからリダイレクト情報を抽出
  - ユーザーにエラーメッセージとプロフィール作成ページへのリンクを表示
  - コンポーネント（AdviceCard, DetailedNutritionAdvice）でのエラーハンドリング実装

## 7. テーブル設計 (daily_nutri_advice)
- **役割**: 生成されたアドバイスを保存するためのテーブル構造
- **主要フィールド**:
  - **id**: 一意のアドバイスID
  - **user_id**: ユーザーID（外部キー）
  - **advice_date**: アドバイス生成日
  - **advice_type**: アドバイスタイプ（summary/detailed）
  - **advice_summary**: アドバイスの要約
  - **advice_detail**: 詳細なアドバイス内容
  - **recommended_foods**: 推奨食品リスト
  - **is_read**: 既読状態
  - **created_at**: レコード作成日時

## 8. クライアント側の実装
### ホーム画面のアドバイスカード (src/components/home/advice-card.tsx)
- **役割**: ホーム画面に表示する栄養アドバイスの要約を取得・表示します。
- **主な機能**:
  - **fetchAdvice関数**: APIからアドバイスを取得
  - **エラーハンドリング**: プロフィール未設定時のエラー表示とリダイレクトリンク
  - **ローディング状態**: データ取得中の表示制御
  - **既読管理**: アドバイスの既読状態の更新

### 詳細アドバイス表示 (src/components/dashboard/nutrition-advice.tsx)
- **役割**: ダッシュボードに表示する詳細な栄養アドバイスを取得・表示します。
- **主な機能**:
  - **fetchDetailedAdvice関数**: APIから詳細アドバイスを取得
  - **エラーハンドリング**: プロフィール未設定時のエラー表示とリダイレクトボタン
  - **既読状態更新**: アドバイスを表示した際に既読状態を更新
  - **推奨食品表示**: アドバイスに含まれる推奨食品リストの表示

### ダッシュボードのアドバイス履歴 (src/app/(authenticated)/dashboard/page.tsx)
- **役割**: ユーザーのアドバイス履歴を取得・表示し、新規アドバイスの生成を可能にします。
- **主な機能**:
  - **fetchAdviceHistory関数**: Supabaseからアドバイス履歴を取得
  - **refreshAdvice関数**: 強制更新モードでAPIを呼び出し、新規アドバイスを生成
  - **アドバイス履歴表示**: 日付順に並べたアドバイス履歴のリスト表示
  - **未読表示**: 未読アドバイスの視覚的な強調表示
  - **更新ボタン**: 手動でのアドバイス更新機能

## 処理フロー概要
1. ユーザー認証の確認
2. 既存アドバイスの確認（forceパラメータに応じて処理分岐）
3. ユーザープロフィールの取得
4. 妊娠週数とトライメスターの計算
5. 栄養状態データの取得と不足栄養素の特定
6. 現在の季節の取得
7. AIサービスによるアドバイス生成
8. 生成されたアドバイスのデータベースへの保存
9. クライアントへのレスポンス返却

## ユーザーフロー
1. **ホーム画面**: 最新のアドバイス要約を表示
   - プロフィール未設定時: エラーメッセージとプロフィール作成リンクを表示
   - アドバイス取得成功時: 要約と推奨食品を表示
2. **ダッシュボード**: 詳細アドバイスとアドバイス履歴を表示
   - 詳細アドバイス: 最新のアドバイスの詳細内容を表示
   - アドバイス履歴: 過去のアドバイス一覧を表示
   - 更新ボタン: 最新の栄養データに基づいた新規アドバイスを生成

この仕組みにより、ユーザーの妊娠状態と栄養摂取状況に基づいた、パーソナライズされた栄養アドバイスを提供することができます。また、アドバイス履歴の管理や強制更新機能により、ユーザーは常に最新の情報を得ることができます。

## 実装上の注意点
1. **テーブル名の統一**: コード内では`daily_nutri_advice`テーブルを参照しており、テーブル名の一貫性を保つことが重要
2. **エラーハンドリング**: クライアント側でのエラー表示とリダイレクト処理の実装が必要
3. **プロフィール依存関係**: アドバイス生成にはプロフィール情報が必須であり、プロフィール未設定時の適切な誘導が重要
4. **栄養データの扱い**: 栄養データが存在しない場合のデフォルト値設定と、データ更新時のアドバイス再生成の考慮
5. **テーブル参照の一貫性**: APIでは`profiles`テーブルからプロフィール情報を取得しており、テーブル名の変更時は全ての参照を更新する必要がある 

### 現在の実装

#### 手動更新
- ダッシュボード画面の「更新ボタン」を使用して、ユーザーは新しいアドバイスを明示的に生成できます。
- この機能は `refreshAdvice` 関数で実装されており、APIに `force=true` パラメータを送信することで、既存のアドバイスがあっても新規生成を強制します。

#### 条件付き自動更新
- アドバイスが存在しない場合、APIリクエスト時に自動的に新規生成されます。
- 日付が変わった場合（前回のアドバイスが今日のものでない場合）も新規生成されます。

#### 将来的な自動更新トリガー（計画段階）
- 栄養状態の大きな変化時
- 妊娠周数の変化時
- 過去アドバイスの自動アーカイブ（過去7日分を保持）

現状では、完全な自動更新（例：栄養データが更新されるたびに自動的にアドバイスを更新する）は実装されておらず、主にユーザーの手動操作または日付変更による更新が中心です。`procedure-3-6.md` の改善計画にあるように、AIアドバイス更新システムの設計はさらなる拡張が予定されており、より洗練された自動更新の仕組みが今後実装される可能性があります。

# カテゴリ別の影響箇所（影響度の高い順）

1. **型定義・コア関数（非常に高影響）**
   - `src/types/nutrition.ts`: 基本となる `NutritionData` と `StandardizedMealNutrition` の型定義があり、アプリ全体で参照されている
   - `src/lib/nutrition/nutrition-type-utils.ts`: 型変換の中核となるユーティリティ関数が集約されている
   - `src/lib/nutrition/nutrition-utils.ts`: 栄養関連の計算処理や標準化処理を含む
   - `src/types/meal.ts`, `src/types/api-interfaces.ts`: 他の重要な型定義ファイル

2. **データアクセス層・サービス層（高影響）**
   - `src/lib/supabase/client.ts`: データベース操作と型変換が密接に関連している
   - `src/lib/services/meal-service.ts`: 食事データの保存処理で型変換が多用されている
   - `src/lib/api/api-adapter.ts`: API応答データの変換と型管理の中核
   - `src/lib/nutrition/nutrition-service-impl.ts`: 栄養計算のコアロジック

3. **API層（中〜高影響）**
   - `src/app/api/meals/route.ts`, `src/app/api/update-nutrition-log/route.ts`: DB操作と直接結合
   - `src/app/api/v2/nutrition-advice/route.ts`: 栄養アドバイス機能の基盤
   - `src/types/api/endpoints.ts`: API型定義

4. **UI層・コンポーネント（中影響）**
   - `src/components/nutrition/NutritionDataDisplay.tsx`: 栄養データ表示の中核コンポーネント
   - `src/components/dashboard/nutrition-chart.tsx`: 栄養チャート表示
   - `src/components/meals/enhanced-recognition-editor.tsx`: 食事認識編集機能
   - `src/app/(authenticated)/dashboard/page.tsx`: ダッシュボード表示
   - `src/app/(authenticated)/meals/log/page.tsx`: 食事ログページ

5. **ユーティリティ・ヘルパー（低〜中影響）**
   - `src/lib/validation/response-validators.ts`: 型検証関数
   - `src/lib/nutrition/nutrition-display-utils.ts`: 表示用ユーティリティ
   - `src/hooks/useNutrition.ts`: 栄養関連フック

6. **テスト（低影響）**
   - `__tests__/lib/nutrition/nutrition-type-utils.test.ts`: 型変換テスト

# 移行戦略のレビュー

## 1. 計画の完全性評価

- **コードカバレッジ**: 指示書の移行計画は、型定義から始まりAPI・DB層、UIコンポーネントまで、影響を受けるすべての層をカバーしている
- **段階的アプローチ**: コアロジック→データアクセス→UI→API→最適化という流れは論理的で、依存関係を考慮している
- **検証ポイント**: 各ステップにチェック項目が設けられており、進捗と品質を確認できる

## 2. リスク評価と対策

- **強み**:
  - 変換関数 (`convertToStandardizedNutrition`, `convertToLegacyNutrition`) が既に実装済みで安定している
  - 既存テストが存在し、変換ロジックの基本検証ができる
  - 後方互換性への配慮がある (`legacyNutrition` フィールドなど)

- **課題・リスク**:
  - DB操作部分は影響が大きく、データ整合性の問題が発生する可能性がある
  - UIコンポーネントの変更は慎重に行わないと、ユーザー体験に影響する恐れがある
  - 大量の型変更によるコンパイルエラーの一時的な増加

- **対策提案**:
  - 各ステップでの厳密なテスト実行（特にDB操作後のデータ検証）
  - UI層の変更時には視覚的な差分がないことを明示的に確認する手順の追加
  - 一時的に型エラーを許容するTSConfig設定の検討（移行期間中のみ）

## 3. スケジュールと優先順位

- DB操作とAPIレスポンスの部分は慎重に進める必要があり、時間配分を多めに見積もるべき
- UIコンポーネントの移行は並行作業で進められる可能性がある
- 最も影響度の高い `nutrition-type-utils.ts` は早期に完成させ、他の部分の変更をサポートする基盤とすべき

## 4. テスト戦略の評価

- 既存のユニットテストに加え、以下のテスト強化が望ましい:
  - 統合テスト: 特にデータフローの全体を通したテスト（API→DB→UI）
  - スナップショットテスト: UI変更の影響を検出するため
  - パフォーマンステスト: 変換処理のオーバーヘッドを評価

## 5. 結論

移行計画は全体的に網羅的で段階的アプローチが適切に設計されている。リスクへの対応も考慮されており、各ステップのチェックポイントが明確。特にデータアクセス層とUI層の移行に注意を払いつつ、計画通りに進めることで、安全に型定義の統一を達成できると評価する。

◤◢◤◢◤◢◤◢◤◢◤◢◤◢
